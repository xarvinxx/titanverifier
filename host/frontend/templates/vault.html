<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-950">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Manager — Vault</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: {
                            50:  '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0',
                            300: '#86efac', 400: '#4ade80', 500: '#22c55e',
                            600: '#16a34a', 700: '#15803d', 800: '#166534',
                            900: '#14532d', 950: '#052e16',
                        }
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
        .modal-backdrop { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
        .vault-row:hover { background: rgba(31, 41, 55, 0.5); }
        .field-input {
            width: 100%; padding: 0.5rem 0.75rem;
            background: rgb(31 41 55); border: 1px solid rgb(55 65 81);
            border-radius: 0.5rem; font-size: 0.875rem; color: rgb(229 231 235);
        }
        .field-input::placeholder { color: rgb(107 114 128); }
        .field-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(34,197,94,0.3); }
        .section-title {
            padding-top: 0.5rem; border-top: 1px solid rgb(31 41 55);
            font-size: 10px; color: rgb(75 85 99); text-transform: uppercase;
            letter-spacing: 0.1em; display: flex; align-items: center; gap: 0.5rem;
        }
        /* Checkbox Styling für Dark Mode */
        input[type="checkbox"] {
            appearance: none; -webkit-appearance: none;
            width: 14px; height: 14px;
            border: 1.5px solid rgb(75 85 99); border-radius: 3px;
            background: rgb(31 41 55); cursor: pointer;
            position: relative; transition: all 0.15s;
        }
        input[type="checkbox"]:checked {
            background: rgb(99 102 241); border-color: rgb(99 102 241);
        }
        input[type="checkbox"]:checked::after {
            content: ''; position: absolute; left: 3px; top: 0px;
            width: 5px; height: 9px;
            border: solid white; border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        input[type="checkbox"]:indeterminate {
            background: rgb(99 102 241); border-color: rgb(99 102 241);
        }
        input[type="checkbox"]:indeterminate::after {
            content: ''; position: absolute; left: 2px; top: 5px;
            width: 8px; height: 0;
            border-bottom: 2px solid white;
        }
        input[type="checkbox"]:hover { border-color: rgb(129 140 248); }
        input[type="checkbox"]:focus { box-shadow: 0 0 0 2px rgba(99,102,241,0.3); outline: none; }
        .vault-row.bg-indigo-900\/10 { background: rgba(49, 46, 129, 0.1); }
    </style>
</head>
<body class="h-full text-gray-100 antialiased">

<div class="min-h-full flex flex-col">

    <!-- HEADER -->
    <header class="bg-gray-900/80 backdrop-blur-sm border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14">

                <!-- LEFT: Device Status -->
                <div class="flex items-center gap-4">
                    <!-- Device Status Bar -->
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-1.5">
                            <span class="text-[10px] text-gray-600 uppercase">ADB</span>
                            <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-600"></div>
                            <span id="status-text" class="text-[11px] font-medium text-gray-500">—</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="text-[10px] text-gray-600 uppercase">Root</span>
                            <span id="header-root" class="text-[11px] font-medium text-gray-500">—</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="text-[10px] text-gray-600 uppercase">IP</span>
                            <span id="header-ip" class="text-[11px] font-mono font-medium text-gray-500">—</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="text-[10px] text-gray-600 uppercase">DNA</span>
                            <span id="header-dna" class="text-[11px] font-mono font-medium text-gray-500">—</span>
                        </div>
                    </div>

                    <!-- Separator -->
                    <div class="w-px h-6 bg-gray-800"></div>

                    <!-- Flow Status -->
                    <div id="flow-badge" class="hidden items-center gap-2">
                        <svg class="w-3 h-3 text-amber-400 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <span id="flow-badge-text" class="text-[11px] font-semibold text-amber-400">Flow aktiv</span>
                        <button onclick="headerAbortFlow()"
                                class="ml-1 p-1 rounded bg-red-600/20 border border-red-600/30 hover:bg-red-600/30 transition-all"
                                title="Flow abbrechen">
                            <svg class="w-3 h-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div id="flow-idle" class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-gray-700"></div>
                        <span class="text-[10px] text-gray-600">Kein Flow</span>
                    </div>
                </div>

                <!-- RIGHT: Navigation -->
                <nav class="flex items-center gap-1">
                    <a href="/"
                       class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-all">
                        Dashboard
                    </a>
                    <a href="/vault"
                       class="px-3 py-1.5 rounded-lg text-xs font-medium text-white bg-gray-800 border border-gray-700">
                        Vault
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 max-w-[1400px] w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- Title + Actions -->
        <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                </svg>
                <h2 class="text-lg font-semibold text-white">Profile Vault</h2>
                <span id="profile-count" class="text-xs text-gray-600">(0)</span>
            </div>
            <div class="flex items-center gap-2">
                <!-- Filter: Status -->
                <select id="filter-status" onchange="loadProfiles()"
                        class="px-2 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs text-gray-300 focus:outline-none">
                    <option value="">Alle Status</option>
                    <option value="warmup">Warmup</option>
                    <option value="active">Active</option>
                    <option value="cooldown">Cooldown</option>
                    <option value="banned">Banned</option>
                    <option value="archived">Archived</option>
                </select>
                <button onclick="openCreateModal()"
                        class="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-accent-600 hover:bg-accent-500
                               text-white text-xs font-semibold transition-all shadow-lg shadow-accent-600/20">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Neues Profil
                </button>
                <button onclick="loadProfiles()"
                        class="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700
                               border border-gray-700 text-gray-300 text-xs font-medium transition-all">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Toast -->
        <div id="vault-toast" class="hidden mb-4 p-3 rounded-lg text-sm"></div>

        <!-- BULK ACTION BAR -->
        <div id="bulk-bar" class="hidden mb-4 p-3 rounded-xl bg-indigo-600/10 border border-indigo-500/30 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-sm font-semibold text-indigo-300">
                    <span id="bulk-count">0</span> ausgewählt
                </span>
                <button onclick="bulkSelectAll()" class="text-[11px] text-indigo-400 hover:text-indigo-300 underline underline-offset-2">Alle</button>
                <button onclick="bulkDeselectAll()" class="text-[11px] text-gray-500 hover:text-gray-400 underline underline-offset-2">Keine</button>
            </div>
            <div class="flex items-center gap-2">
                <!-- Bulk Status -->
                <select id="bulk-status-select" class="px-2 py-1.5 rounded-lg bg-gray-800 border border-gray-700 text-xs text-gray-300 focus:outline-none">
                    <option value="">Status ändern...</option>
                    <option value="warmup">→ Warmup</option>
                    <option value="active">→ Active</option>
                    <option value="cooldown">→ Cooldown</option>
                    <option value="banned">→ Banned</option>
                    <option value="suspended">→ Suspended</option>
                </select>
                <button onclick="bulkSetStatus()"
                        class="px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-600/20 text-blue-400 border border-blue-600/30 hover:bg-blue-600/30 transition-all">
                    Anwenden
                </button>
                <div class="w-px h-5 bg-gray-700 mx-1"></div>
                <button onclick="bulkArchive()"
                        class="px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-600/20 text-amber-400 border border-amber-600/30 hover:bg-amber-600/30 transition-all">
                    Archivieren
                </button>
                <button onclick="bulkUnarchive()"
                        class="px-3 py-1.5 rounded-lg text-xs font-medium bg-cyan-600/20 text-cyan-400 border border-cyan-600/30 hover:bg-cyan-600/30 transition-all">
                    Wiederherstellen
                </button>
                <button onclick="bulkDelete()"
                        class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-red-600/20 text-red-400 border border-red-600/30 hover:bg-red-600/30 transition-all">
                    Löschen
                </button>
            </div>
        </div>

        <!-- DATA GRID -->
        <div class="bg-gray-900/50 border border-gray-800 rounded-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left text-xs text-gray-500 uppercase tracking-wider bg-gray-900/60">
                            <th class="px-3 py-3 font-medium w-8">
                                <input type="checkbox" id="select-all-cb"
                                       onchange="toggleSelectAll(this.checked)"
                                       class="w-3.5 h-3.5 rounded border-gray-600 bg-gray-800 text-indigo-500 focus:ring-indigo-500/30 cursor-pointer">
                            </th>
                            <th class="px-3 py-3 font-medium w-10">#</th>
                            <th class="px-3 py-3 font-medium">Profil</th>
                            <th class="px-3 py-3 font-medium">Status</th>
                            <th class="px-3 py-3 font-medium">Social Media</th>
                            <th class="px-3 py-3 font-medium">IP</th>
                            <th class="px-3 py-3 font-medium">Audit</th>
                            <th class="px-3 py-3 font-medium">Backups</th>
                            <th class="px-3 py-3 font-medium">Erstellt</th>
                            <th class="px-3 py-3 font-medium text-center">Sw.</th>
                            <th class="px-3 py-3 font-medium text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vault-grid" class="divide-y divide-gray-800/50">
                        <tr>
                            <td colspan="11" class="px-4 py-12 text-center text-gray-600">
                                <svg class="w-8 h-8 mx-auto mb-2 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                          d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                </svg>
                                <p class="text-sm">Keine Profile im Vault</p>
                                <p class="text-xs mt-1">Erstelle ein Profil oder starte einen Genesis-Flow</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="border-t border-gray-800/50 py-3">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between">
            <p class="text-[10px] text-gray-700">Device Manager v2.1.0</p>
            <p class="text-[10px] text-gray-700" id="footer-clock"></p>
        </div>
    </footer>
</div>

<!-- =============================================================== -->
<!-- MODAL: Create Profile -->
<!-- =============================================================== -->
<div id="create-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl mx-4 p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-base font-semibold text-white">Neues Profil erstellen</h3>
            <button onclick="closeCreateModal()" class="text-gray-500 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="space-y-3">
            <!-- Core -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Account Name *</label>
                    <input id="c-name" type="text" placeholder="z.B. TikTok_DE_001" class="field-input">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Identity ID *</label>
                    <input id="c-identity-id" type="number" placeholder="ID" class="field-input">
                </div>
            </div>

            <!-- TikTok -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-pink-500"></span> TikTok</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="c-tt-user" type="text" placeholder="@username" class="field-input">
                <input id="c-tt-email" type="email" placeholder="Email" class="field-input">
                <input id="c-tt-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- Instagram -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-purple-500"></span> Instagram</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="c-ig-user" type="text" placeholder="@username" class="field-input">
                <input id="c-ig-email" type="email" placeholder="Email" class="field-input">
                <input id="c-ig-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- YouTube -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-red-500"></span> YouTube</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="c-yt-user" type="text" placeholder="Channel Name" class="field-input">
                <input id="c-yt-email" type="email" placeholder="Email" class="field-input">
                <input id="c-yt-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- Snapchat -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> Snapchat</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="c-sc-user" type="text" placeholder="@username" class="field-input">
                <input id="c-sc-email" type="email" placeholder="Email" class="field-input">
                <input id="c-sc-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- Google -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Google Account</div>
            <div class="grid grid-cols-2 gap-3">
                <input id="c-google-email" type="email" placeholder="user@gmail.com" class="field-input">
                <input id="c-google-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- Contact Email -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-cyan-500"></span> Kontakt Email</div>
            <div class="grid grid-cols-2 gap-3">
                <input id="c-contact-email" type="email" placeholder="kontakt@mail.de" class="field-input">
                <input id="c-contact-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- Proxy -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-gray-500"></span> Proxy</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="c-proxy" type="text" placeholder="ip:port" class="field-input">
                <select id="c-proxy-type" class="field-input">
                    <option value="none">None</option>
                    <option value="socks5">SOCKS5</option>
                    <option value="http">HTTP</option>
                    <option value="socks4">SOCKS4</option>
                </select>
                <input id="c-proxy-auth" type="text" placeholder="user:pass" class="field-input">
            </div>

            <!-- Notes -->
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Notes</label>
                <textarea id="c-notes" rows="2" placeholder="Optionale Notizen..." class="field-input" style="resize:vertical;"></textarea>
            </div>
        </div>
        <div class="flex justify-end gap-2 mt-5">
            <button onclick="closeCreateModal()"
                    class="px-4 py-2 rounded-lg text-xs font-medium text-gray-400 bg-gray-800 hover:bg-gray-700 transition-all">Abbrechen</button>
            <button onclick="submitCreate()"
                    class="px-4 py-2 rounded-lg text-xs font-semibold text-white bg-accent-600 hover:bg-accent-500 transition-all shadow-lg shadow-accent-600/20">Erstellen</button>
        </div>
    </div>
</div>

<!-- =============================================================== -->
<!-- MODAL: Edit Profile -->
<!-- =============================================================== -->
<div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl mx-4 p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-base font-semibold text-white">Profil bearbeiten <span id="edit-title" class="text-accent-400"></span></h3>
            <button onclick="closeEditModal()" class="text-gray-500 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <input type="hidden" id="e-id">

        <div class="space-y-3">
            <!-- Core -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Account Name</label>
                    <input id="e-name" type="text" class="field-input">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Status</label>
                    <select id="e-status" class="field-input">
                        <option value="warmup">Warmup</option>
                        <option value="active">Active</option>
                        <option value="cooldown">Cooldown</option>
                        <option value="banned">Banned</option>
                        <option value="suspended">Suspended</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
            </div>

            <!-- TikTok -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-pink-500"></span> TikTok</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="e-tt-user" type="text" placeholder="@username" class="field-input">
                <input id="e-tt-email" type="email" placeholder="Email" class="field-input">
                <input id="e-tt-pass" type="text" placeholder="Passwort" class="field-input">
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label class="block text-[10px] text-gray-600 mb-0.5">Followers</label>
                    <input id="e-tt-followers" type="number" placeholder="0" class="field-input">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-600 mb-0.5">Following</label>
                    <input id="e-tt-following" type="number" placeholder="0" class="field-input">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-600 mb-0.5">Likes</label>
                    <input id="e-tt-likes" type="number" placeholder="0" class="field-input">
                </div>
            </div>

            <!-- Instagram -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-purple-500"></span> Instagram</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="e-ig-user" type="text" placeholder="@username" class="field-input">
                <input id="e-ig-email" type="email" placeholder="Email" class="field-input">
                <input id="e-ig-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- YouTube -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-red-500"></span> YouTube</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="e-yt-user" type="text" placeholder="Channel Name" class="field-input">
                <input id="e-yt-email" type="email" placeholder="Email" class="field-input">
                <input id="e-yt-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- Snapchat -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> Snapchat</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="e-sc-user" type="text" placeholder="@username" class="field-input">
                <input id="e-sc-email" type="email" placeholder="Email" class="field-input">
                <input id="e-sc-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- Google -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Google Account</div>
            <div class="grid grid-cols-2 gap-3">
                <input id="e-google-email" type="email" placeholder="user@gmail.com" class="field-input">
                <input id="e-google-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- Contact -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-cyan-500"></span> Kontakt Email</div>
            <div class="grid grid-cols-2 gap-3">
                <input id="e-contact-email" type="email" placeholder="kontakt@mail.de" class="field-input">
                <input id="e-contact-pass" type="text" placeholder="Passwort" class="field-input">
            </div>

            <!-- Proxy -->
            <div class="section-title"><span class="w-2 h-2 rounded-full bg-gray-500"></span> Proxy</div>
            <div class="grid grid-cols-3 gap-3">
                <input id="e-proxy" type="text" placeholder="ip:port" class="field-input">
                <select id="e-proxy-type" class="field-input">
                    <option value="none">None</option>
                    <option value="socks5">SOCKS5</option>
                    <option value="http">HTTP</option>
                    <option value="socks4">SOCKS4</option>
                </select>
                <input id="e-proxy-auth" type="text" placeholder="user:pass" class="field-input">
            </div>

            <!-- Notes -->
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Notes</label>
                <textarea id="e-notes" rows="2" placeholder="Optionale Notizen..." class="field-input" style="resize:vertical;"></textarea>
            </div>
        </div>

        <div class="flex justify-between mt-5">
            <div class="flex gap-2">
                <button onclick="archiveFromEdit()"
                        class="px-3 py-2 rounded-lg text-xs font-medium text-gray-400 bg-gray-800 hover:bg-gray-700 border border-gray-700 transition-all">
                    Archivieren
                </button>
                <button onclick="deleteFromEdit()"
                        class="px-3 py-2 rounded-lg text-xs font-medium text-red-400 bg-red-600/10 hover:bg-red-600/20 border border-red-600/30 transition-all">
                    Loeschen
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="closeEditModal()"
                        class="px-4 py-2 rounded-lg text-xs font-medium text-gray-400 bg-gray-800 hover:bg-gray-700 transition-all">Abbrechen</button>
                <button onclick="submitEdit()"
                        class="px-4 py-2 rounded-lg text-xs font-semibold text-white bg-blue-600 hover:bg-blue-500 transition-all shadow-lg shadow-blue-600/20">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================================== -->
<!-- MODAL: Profile Detail -->
<!-- =============================================================== -->
<div id="detail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800 sticky top-0 bg-gray-900 z-10">
            <div>
                <h3 class="text-sm font-semibold text-white" id="pd-title">Detail</h3>
                <p class="text-[10px] text-gray-500" id="pd-subtitle"></p>
            </div>
            <button onclick="closeDetailModal()" class="text-gray-500 hover:text-white transition-colors p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div id="pd-body" class="p-6 space-y-5">
            <div class="text-center py-8 text-gray-600 text-sm">Lade...</div>
        </div>
    </div>
</div>


<!-- =============================================================== -->
<!-- JAVASCRIPT -->
<!-- =============================================================== -->
<script>
    // ===================================================================
    // Load Profiles
    // ===================================================================
    async function loadProfiles() {
        try {
            const res = await fetch('/api/vault');
            const data = await res.json();
            let profiles = data.profiles || [];
            const grid = document.getElementById('vault-grid');
            const count = document.getElementById('profile-count');

            // Filter
            const statusFilter = document.getElementById('filter-status').value;
            if (statusFilter) profiles = profiles.filter(p => p.status === statusFilter);

            count.textContent = `(${profiles.length})`;

            if (profiles.length === 0) {
                grid.innerHTML = `<tr>
                    <td colspan="11" class="px-4 py-12 text-center text-gray-600">
                        <p class="text-sm">Keine Profile gefunden</p>
                    </td>
                </tr>`;
                updateBulkBar();
                return;
            }

            grid.innerHTML = profiles.map(p => {
                // Social Media Badges
                const sm = [];
                if (p.tiktok_username) sm.push('<span class="px-1 py-0.5 rounded text-[9px] bg-pink-500/10 text-pink-400 border border-pink-500/30">TT</span>');
                if (p.instagram_username) sm.push('<span class="px-1 py-0.5 rounded text-[9px] bg-purple-500/10 text-purple-400 border border-purple-500/30">IG</span>');
                if (p.youtube_username) sm.push('<span class="px-1 py-0.5 rounded text-[9px] bg-red-500/10 text-red-400 border border-red-500/30">YT</span>');
                if (p.snapchat_username) sm.push('<span class="px-1 py-0.5 rounded text-[9px] bg-yellow-500/10 text-yellow-400 border border-yellow-500/30">SC</span>');
                const smStr = sm.length ? sm.join(' ') : '<span class="text-gray-600 text-[10px]">—</span>';

                // Backups
                const bkps = [];
                if (p.backup_status === 'valid') bkps.push('TT');
                if (p.gms_backup_status === 'valid') bkps.push('GMS');
                if (p.accounts_backup_status === 'valid') bkps.push('ACC');
                const bkpStr = bkps.length > 0
                    ? `<span class="text-green-400 text-[10px]">${bkps.join('+')}</span>`
                    : '<span class="text-gray-600 text-[10px]">none</span>';

                return `
                <tr class="vault-row transition-colors group cursor-pointer" onclick="openDetail(${p.id})" data-profile-id="${p.id}">
                    <td class="px-3 py-2.5" onclick="event.stopPropagation()">
                        <input type="checkbox" class="profile-cb w-3.5 h-3.5 rounded border-gray-600 bg-gray-800
                               text-indigo-500 focus:ring-indigo-500/30 cursor-pointer"
                               value="${p.id}" onchange="onProfileCheckChange()">
                    </td>
                    <td class="px-3 py-2.5 font-mono text-xs text-gray-500">#${p.id}</td>
                    <td class="px-3 py-2.5">
                        <div class="font-medium text-gray-200 text-sm">${esc(p.name)}</div>
                        <div class="text-[10px] text-gray-600 font-mono">${esc(p.identity_serial || '—')} <span class="text-gray-700">· ID #${p.identity_id}</span></div>
                    </td>
                    <td class="px-3 py-2.5">${statusBadge(p.status)}</td>
                    <td class="px-3 py-2.5"><div class="flex flex-wrap gap-1">${smStr}</div></td>
                    <td class="px-3 py-2.5 font-mono text-xs text-gray-500">${esc(p.identity_last_ip || '—')}</td>
                    <td class="px-3 py-2.5 text-xs">
                        ${p.identity_audit_score != null
                            ? `<span class="${p.identity_audit_score >= 100 ? 'text-green-400' : p.identity_audit_score >= 50 ? 'text-amber-400' : 'text-red-400'} font-semibold">${p.identity_audit_score}%</span>`
                            : '<span class="text-gray-600">—</span>'
                        }
                    </td>
                    <td class="px-3 py-2.5 text-[10px] font-mono">${bkpStr}</td>
                    <td class="px-3 py-2.5 text-xs text-gray-500">${fmtDate(p.created_at)}</td>
                    <td class="px-3 py-2.5 text-center">
                        <span class="text-xs font-mono text-gray-500">${p.switch_count || 0}</span>
                    </td>
                    <td class="px-3 py-2.5">
                        <div class="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); openEditModal(${p.id})" title="Bearbeiten"
                                    class="p-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-blue-400 transition-all border border-gray-700">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); loadProfile(${p.identity_id}, '${esc(p.name)}')" title="Switch"
                                    class="p-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-accent-400 transition-all border border-gray-700">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); archiveProfile(${p.id}, '${esc(p.name)}')" title="Archivieren"
                                    class="p-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-amber-400 transition-all border border-gray-700">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteProfile(${p.id}, '${esc(p.name)}')" title="Loeschen"
                                    class="p-1.5 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-red-400 transition-all border border-gray-700">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');

            // Selection-State wiederherstellen
            updateBulkBar();
            document.getElementById('select-all-cb').checked = false;

        } catch (e) {
            console.error('Load profiles error:', e);
            showToast('Fehler beim Laden der Profile: ' + e.message, 'error');
        }
    }

    // ===================================================================
    // Create Profile
    // ===================================================================
    function openCreateModal() {
        document.getElementById('create-modal').classList.remove('hidden');
        document.getElementById('c-name').focus();
    }
    function closeCreateModal() {
        document.getElementById('create-modal').classList.add('hidden');
        document.querySelectorAll('#create-modal input, #create-modal textarea').forEach(el => el.value = '');
        document.getElementById('c-proxy-type').value = 'none';
    }

    async function submitCreate() {
        const name = document.getElementById('c-name').value.trim();
        const identityId = parseInt(document.getElementById('c-identity-id').value);
        if (!name) { showToast('Name ist erforderlich.', 'warn'); return; }
        if (!identityId) { showToast('Identity ID ist erforderlich.', 'warn'); return; }

        const proxyAuth = document.getElementById('c-proxy-auth').value.trim();
        const [pu, pp] = proxyAuth.includes(':') ? proxyAuth.split(':') : [null, null];

        try {
            const res = await fetch('/api/vault', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name, identity_id: identityId,
                    tiktok_username: gv('c-tt-user'), tiktok_email: gv('c-tt-email'), tiktok_password: gv('c-tt-pass'),
                    instagram_username: gv('c-ig-user'), instagram_email: gv('c-ig-email'), instagram_password: gv('c-ig-pass'),
                    youtube_username: gv('c-yt-user'), youtube_email: gv('c-yt-email'), youtube_password: gv('c-yt-pass'),
                    snapchat_username: gv('c-sc-user'), snapchat_email: gv('c-sc-email'), snapchat_password: gv('c-sc-pass'),
                    google_email: gv('c-google-email'), google_password: gv('c-google-pass'),
                    contact_email: gv('c-contact-email'), contact_password: gv('c-contact-pass'),
                    proxy_ip: gv('c-proxy'), proxy_type: document.getElementById('c-proxy-type').value,
                    proxy_username: pu, proxy_password: pp,
                    notes: gv('c-notes'),
                }),
            });
            const data = await res.json();
            if (res.ok) { showToast(data.message, 'success'); closeCreateModal(); loadProfiles(); }
            else showToast(data.detail || 'Fehler', 'error');
        } catch (e) { showToast('Netzwerkfehler: ' + e.message, 'error'); }
    }

    // ===================================================================
    // Edit Profile
    // ===================================================================
    async function openEditModal(id) {
        try {
            const res = await fetch(`/api/vault/${id}`);
            if (!res.ok) { showToast('Profil nicht gefunden', 'error'); return; }
            const p = await res.json();

            document.getElementById('e-id').value = p.id;
            document.getElementById('edit-title').textContent = `#${p.id} — ${p.name}`;
            sv('e-name', p.name);
            document.getElementById('e-status').value = p.status || 'warmup';

            sv('e-tt-user', p.tiktok_username); sv('e-tt-email', p.tiktok_email); sv('e-tt-pass', p.tiktok_password);
            sv('e-tt-followers', p.tiktok_followers); sv('e-tt-following', p.tiktok_following); sv('e-tt-likes', p.tiktok_likes);
            sv('e-ig-user', p.instagram_username); sv('e-ig-email', p.instagram_email); sv('e-ig-pass', p.instagram_password);
            sv('e-yt-user', p.youtube_username); sv('e-yt-email', p.youtube_email); sv('e-yt-pass', p.youtube_password);
            sv('e-sc-user', p.snapchat_username); sv('e-sc-email', p.snapchat_email); sv('e-sc-pass', p.snapchat_password);
            sv('e-google-email', p.google_email); sv('e-google-pass', p.google_password);
            sv('e-contact-email', p.contact_email); sv('e-contact-pass', p.contact_password);
            sv('e-proxy', p.proxy_ip);
            document.getElementById('e-proxy-type').value = p.proxy_type || 'none';
            sv('e-proxy-auth', (p.proxy_username && p.proxy_password) ? `${p.proxy_username}:${p.proxy_password}` : '');
            sv('e-notes', p.notes);

            document.getElementById('edit-modal').classList.remove('hidden');
        } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
    }
    function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }

    async function submitEdit() {
        const id = document.getElementById('e-id').value;
        const body = {};
        const fields = {
            name: 'e-name', status: 'e-status',
            tiktok_username: 'e-tt-user', tiktok_email: 'e-tt-email', tiktok_password: 'e-tt-pass',
            instagram_username: 'e-ig-user', instagram_email: 'e-ig-email', instagram_password: 'e-ig-pass',
            youtube_username: 'e-yt-user', youtube_email: 'e-yt-email', youtube_password: 'e-yt-pass',
            snapchat_username: 'e-sc-user', snapchat_email: 'e-sc-email', snapchat_password: 'e-sc-pass',
            google_email: 'e-google-email', google_password: 'e-google-pass',
            contact_email: 'e-contact-email', contact_password: 'e-contact-pass',
            proxy_ip: 'e-proxy', proxy_type: 'e-proxy-type', notes: 'e-notes',
        };
        for (const [key, elId] of Object.entries(fields)) {
            const val = document.getElementById(elId).value.trim();
            if (val) body[key] = val;
        }
        // Numerische Felder
        ['e-tt-followers','e-tt-following','e-tt-likes'].forEach(elId => {
            const val = document.getElementById(elId).value;
            if (val) body[elId.replace('e-tt-','tiktok_')] = parseInt(val);
        });
        // Proxy Auth
        const pa = document.getElementById('e-proxy-auth').value.trim();
        if (pa.includes(':')) { const [u,p] = pa.split(':'); body.proxy_username = u; body.proxy_password = p; }

        try {
            const res = await fetch(`/api/vault/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            const data = await res.json();
            if (res.ok) { showToast(data.message || 'Gespeichert.', 'success'); closeEditModal(); loadProfiles(); }
            else showToast(data.detail || 'Fehler', 'error');
        } catch (e) { showToast('Netzwerkfehler: ' + e.message, 'error'); }
    }

    function archiveFromEdit() {
        const id = document.getElementById('e-id').value;
        if (!id) return;
        archiveProfile(parseInt(id), '');
        closeEditModal();
    }
    function deleteFromEdit() {
        const id = document.getElementById('e-id').value;
        if (!id) return;
        deleteProfile(parseInt(id), document.getElementById('e-name').value);
        closeEditModal();
    }

    // ===================================================================
    // Archive / Unarchive
    // ===================================================================
    async function archiveProfile(id, name) {
        if (!confirm(`Profil "${name}" (#${id}) archivieren?`)) return;
        try {
            const res = await fetch(`/api/vault/${id}/archive`, {method: 'PUT'});
            const data = await res.json();
            if (res.ok) { showToast(data.message, 'success'); loadProfiles(); }
            else showToast(data.detail || 'Fehler', 'error');
        } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
    }

    async function unarchiveProfile(id) {
        try {
            const res = await fetch(`/api/vault/${id}/unarchive`, {method: 'PUT'});
            const data = await res.json();
            if (res.ok) { showToast(data.message, 'success'); loadProfiles(); }
            else showToast(data.detail || 'Fehler', 'error');
        } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
    }

    // ===================================================================
    // Delete
    // ===================================================================
    async function deleteProfile(id, name) {
        if (!confirm(`Profil "${name}" (#${id}) ENDGUELTIG loeschen?\n\nDies loescht auch die Identitaet falls keine anderen Profile sie nutzen.`)) return;
        try {
            const res = await fetch(`/api/vault/${id}`, {method: 'DELETE'});
            const data = await res.json();
            if (res.ok) { showToast(data.message, 'success'); loadProfiles(); }
            else showToast(data.detail || 'Fehler', 'error');
        } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
    }

    // ===================================================================
    // Load Profile → Switch Flow
    // ===================================================================
    async function loadProfile(identityId, profileName) {
        if (!confirm(`Switch-Flow fuer Identity #${identityId} starten?\n\n(Full-State Restore: ${profileName})`)) return;
        try {
            const body = profileName ? { profile_name: profileName } : {};
            const res = await fetch(`/api/control/switch/${identityId}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body),
            });
            const data = await res.json();
            if (res.ok) { showToast(data.message + ' Wechsle zum Dashboard...', 'success'); setTimeout(() => window.location.href = '/', 1500); }
            else showToast(data.detail || 'Fehler', 'error');
        } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
    }

    // ===================================================================
    // Profile Detail Modal
    // ===================================================================
    async function openDetail(profileId) {
        const modal = document.getElementById('detail-modal');
        const body = document.getElementById('pd-body');
        modal.classList.remove('hidden');
        body.innerHTML = '<div class="text-center py-8 text-gray-600 text-sm">Lade Details...</div>';

        try {
            const res = await fetch(`/api/vault/${profileId}/detail`);
            if (!res.ok) { body.innerHTML = '<div class="text-center py-8 text-red-400">Nicht gefunden</div>'; return; }
            const data = await res.json();
            const p = data.profile;
            const ips = data.ip_history || [];
            const flows = data.flow_history || [];
            const audits = data.audit_history || [];

            document.getElementById('pd-title').textContent = p.name;
            document.getElementById('pd-subtitle').textContent = `Profil #${p.id} — Identity #${p.identity_id} — ${(p.status || '').toUpperCase()}`;

            body.innerHTML = `
                <!-- Spoofed Hardware Identity (vollständig) -->
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-cyan-400 uppercase tracking-wider mb-3">
                        Spoofed Hardware Identity
                        <span class="text-gray-600 font-normal normal-case ml-1">(Bridge-Datei)</span>
                    </h4>

                    <!-- Säule 1: Property Fingerprinting -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-2 mb-1">Säule 1 — Serial / Build</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${dr('Serial', p.serial)}
                        ${dr('Boot Serial', p.boot_serial)}
                        ${dr('Build ID', p.build_id)}
                        ${dr('Fingerprint', p.build_fingerprint)}
                        ${dr('Security Patch', p.security_patch)}
                    </div>

                    <!-- Säule 2: IMEI / SIM -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-3 mb-1">Säule 2 — IMEI / SIM / Telephony</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${dr('IMEI 1', p.imei1, true)}
                        ${dr('IMEI 2', p.imei2, true)}
                        ${dr('IMSI', p.imsi, true)}
                        ${dr('SIM Serial (ICCID)', p.sim_serial, true)}
                        ${dr('Phone', p.phone_number)}
                        ${dr('Carrier', p.operator_name)}
                        ${dr('SIM Operator', p.sim_operator)}
                        ${dr('SIM Op. Name', p.sim_operator_name)}
                        ${dr('Voicemail', p.voicemail_number)}
                    </div>

                    <!-- Säule 3: Network -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-3 mb-1">Säule 3 — Network Fingerprinting</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${dr('WiFi MAC', p.wifi_mac)}
                    </div>

                    <!-- Säule 4: DRM -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-3 mb-1">Säule 4 — DRM Fingerprinting</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${dr('Widevine ID', p.widevine_id)}
                    </div>

                    <!-- Säule 5: ID Correlation -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-3 mb-1">Säule 5 — ID Correlation</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${dr('GSF ID', p.gsf_id, true)}
                        ${dr('Android ID (hex)', p.android_id)}
                    </div>
                </div>

                <!-- Social Media Credentials -->
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-pink-400 uppercase tracking-wider mb-3">Social Media Accounts</h4>
                    <div class="space-y-2">
                        ${smSection('TikTok', 'pink', p.tiktok_username, p.tiktok_email, p.tiktok_password,
                            p.tiktok_followers || p.tiktok_likes ? `${fmtNum(p.tiktok_followers)}F / ${fmtNum(p.tiktok_following)}Fg / ${fmtNum(p.tiktok_likes)}L` : null)}
                        ${smSection('Instagram', 'purple', p.instagram_username, p.instagram_email, p.instagram_password)}
                        ${smSection('YouTube', 'red', p.youtube_username, p.youtube_email, p.youtube_password)}
                        ${smSection('Snapchat', 'yellow', p.snapchat_username, p.snapchat_email, p.snapchat_password)}
                    </div>
                </div>

                <!-- Google + Contact -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-xs font-semibold text-blue-400 uppercase tracking-wider mb-2">Google</h4>
                        ${dr('Email', p.google_email)} ${dr('Password', p.google_password ? '***' : '—')}
                    </div>
                    <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-xs font-semibold text-cyan-400 uppercase tracking-wider mb-2">Kontakt Email</h4>
                        ${dr('Email', p.contact_email)} ${dr('Password', p.contact_password ? '***' : '—')}
                    </div>
                </div>

                <!-- Network + Audit -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-xs font-semibold text-green-400 uppercase tracking-wider mb-2">Netzwerk</h4>
                        ${dr('Letzte IP', p.identity_last_ip)}
                        ${dr('Service', p.identity_last_ip_service)}
                        ${dr('Zeitpunkt', p.identity_last_ip_at ? fmtDate(p.identity_last_ip_at) : '—')}
                    </div>
                    <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-xs font-semibold text-amber-400 uppercase tracking-wider mb-2">Audit</h4>
                        ${dr('Score', p.identity_audit_score != null ? p.identity_audit_score + '%' : '—')}
                        ${dr('Total', (p.identity_total_audits || 0) + ' Audits')}
                        ${dr('Switches', (p.switch_count || 0) + 'x')}
                    </div>
                </div>

                <!-- Backups -->
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-violet-400 uppercase tracking-wider mb-3">Backups</h4>
                    <div class="grid grid-cols-3 gap-3">
                        ${bkpCard('TikTok', p.backup_status, p.backup_path, p.backup_size_bytes, p.backup_created_at)}
                        ${bkpCard('GMS', p.gms_backup_status, p.gms_backup_path, p.gms_backup_size, p.gms_backup_at)}
                        ${bkpCard('Accounts', p.accounts_backup_status, p.accounts_backup_path, null, p.accounts_backup_at)}
                    </div>
                </div>

                <!-- IP History -->
                ${ips.length > 0 ? `
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-cyan-400 uppercase tracking-wider mb-2">IP History (${ips.length})</h4>
                    ${ips.map(ip => `
                        <div class="flex items-center justify-between py-1 border-b border-gray-800/30 last:border-0">
                            <span class="font-mono text-xs text-cyan-300">${ip.public_ip}</span>
                            <span class="text-[10px] text-gray-500">${ip.ip_service || ''} — ${fmtDate(ip.detected_at)}</span>
                        </div>
                    `).join('')}
                </div>` : ''}

                <!-- Flow History -->
                ${flows.length > 0 ? `
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-amber-400 uppercase tracking-wider mb-2">Flow History (${flows.length})</h4>
                    ${flows.map(f => `
                        <div class="flex items-center justify-between py-1 border-b border-gray-800/30 last:border-0">
                            <div class="flex items-center gap-2">
                                ${typeBadge(f.flow_type)} ${stBadge(f.status)}
                                ${f.public_ip ? `<span class="font-mono text-[10px] text-gray-500">${f.public_ip}</span>` : ''}
                            </div>
                            <span class="text-[10px] text-gray-600">${fmtDate(f.started_at)} ${f.duration_ms ? '(' + (f.duration_ms/1000).toFixed(1) + 's)' : ''}</span>
                        </div>
                    `).join('')}
                </div>` : ''}

                <!-- Audit History -->
                ${audits.length > 0 ? `
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-emerald-400 uppercase tracking-wider mb-2">Audit History (${audits.length})</h4>
                    ${audits.map(a => `
                        <div class="flex items-center justify-between py-1 border-b border-gray-800/30 last:border-0">
                            <span class="font-semibold text-xs ${a.score_percent >= 100 ? 'text-green-400' : 'text-red-400'}">${a.score_percent}% (${a.passed_checks}/${a.total_checks})</span>
                            <span class="text-[10px] text-gray-600">${fmtDate(a.created_at)}</span>
                        </div>
                    `).join('')}
                </div>` : ''}

                <!-- Actions -->
                <div class="flex gap-2 pt-2 border-t border-gray-800">
                    <button onclick="closeDetailModal(); openEditModal(${p.id})"
                            class="px-3 py-2 rounded-lg text-xs font-medium bg-blue-600/20 text-blue-400 border border-blue-600/30 hover:bg-blue-600/30 transition-all">Bearbeiten</button>
                    <button onclick="closeDetailModal(); loadProfile(${p.identity_id}, '${esc(p.name)}')"
                            class="px-3 py-2 rounded-lg text-xs font-medium bg-accent-600/20 text-accent-400 border border-accent-600/30 hover:bg-accent-600/30 transition-all">Switch laden</button>
                    ${p.status === 'archived'
                        ? `<button onclick="closeDetailModal(); unarchiveProfile(${p.id})"
                                  class="px-3 py-2 rounded-lg text-xs font-medium bg-amber-600/20 text-amber-400 border border-amber-600/30 hover:bg-amber-600/30 transition-all">Wiederherstellen</button>`
                        : `<button onclick="closeDetailModal(); archiveProfile(${p.id}, '${esc(p.name)}')"
                                  class="px-3 py-2 rounded-lg text-xs font-medium bg-gray-600/20 text-gray-400 border border-gray-600/30 hover:bg-gray-600/30 transition-all">Archivieren</button>`
                    }
                    <button onclick="closeDetailModal(); deleteProfile(${p.id}, '${esc(p.name)}')"
                            class="px-3 py-2 rounded-lg text-xs font-medium bg-red-600/20 text-red-400 border border-red-600/30 hover:bg-red-600/30 transition-all ml-auto">Loeschen</button>
                </div>
            `;
        } catch (e) { body.innerHTML = `<div class="text-center py-8 text-red-400">Fehler: ${esc(e.message)}</div>`; }
    }
    function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); }

    // ===================================================================
    // Helpers
    // ===================================================================
    function gv(id) { return document.getElementById(id).value.trim() || null; }
    function sv(id, val) { document.getElementById(id).value = val || ''; }
    function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    function decToHex(val) {
        if (!val || typeof val !== 'string') return null;
        const clean = val.trim();
        if (!/^\d{8,}$/.test(clean)) return null;
        try { return BigInt(clean).toString(16).toUpperCase(); } catch { return null; }
    }

    function dr(label, value, showHex) {
        const v = String(value || '—');
        let hexLine = '';
        if (showHex && value && v !== '—') {
            const hex = decToHex(v);
            if (hex) {
                hexLine = `<div class="text-right -mt-0.5 mb-0.5"><span class="text-[9px] font-mono text-gray-600">0x${hex}</span></div>`;
            }
        }
        return `<div>
            <div class="flex items-center justify-between py-0.5">
                <span class="text-[11px] text-gray-500">${label}</span>
                <span class="text-[11px] font-mono text-gray-300">${esc(v)}</span>
            </div>
            ${hexLine}
        </div>`;
    }

    function smSection(name, color, username, email, password, stats) {
        if (!username && !email) return `<div class="flex items-center gap-2 py-1 border-b border-gray-800/30 last:border-0">
            <span class="w-2 h-2 rounded-full bg-${color}-500 opacity-30"></span>
            <span class="text-[11px] text-gray-600">${name}: nicht konfiguriert</span>
        </div>`;
        return `<div class="py-1.5 border-b border-gray-800/30 last:border-0">
            <div class="flex items-center gap-2 mb-1">
                <span class="w-2 h-2 rounded-full bg-${color}-500"></span>
                <span class="text-xs font-medium text-${color}-400">${name}</span>
                ${stats ? `<span class="text-[10px] text-gray-500 ml-auto">${stats}</span>` : ''}
            </div>
            <div class="grid grid-cols-3 gap-2 ml-4">
                <span class="text-[10px] text-gray-400 font-mono">${esc(username || '—')}</span>
                <span class="text-[10px] text-gray-500 font-mono">${esc(email || '—')}</span>
                <span class="text-[10px] text-gray-600">${password ? '***' : '—'}</span>
            </div>
        </div>`;
    }

    function bkpCard(type, status, path, size, at) {
        const ok = status === 'valid';
        return `<div class="bg-gray-900/50 rounded-lg p-3 border ${ok ? 'border-green-800/50' : 'border-gray-800/50'}">
            <div class="flex items-center justify-between mb-1">
                <span class="text-xs font-medium ${ok ? 'text-green-400' : 'text-gray-500'}">${type}</span>
                <span class="px-1.5 py-0.5 rounded text-[9px] font-semibold uppercase ${ok ? 'bg-green-500/10 text-green-400 border border-green-500/30' : 'bg-gray-500/10 text-gray-500 border border-gray-500/30'}">${status || 'none'}</span>
            </div>
            ${path ? `<div class="font-mono text-[9px] text-gray-600 truncate" title="${esc(path)}">${esc(path)}</div>` : ''}
            ${size ? `<div class="text-[9px] text-gray-600">${fmtBytes(size)}</div>` : ''}
            ${at ? `<div class="text-[9px] text-gray-600">${fmtDate(at)}</div>` : ''}
        </div>`;
    }

    function statusBadge(status) {
        const c = {
            warmup: 'bg-amber-500/10 text-amber-400 border-amber-500/30',
            active: 'bg-green-500/10 text-green-400 border-green-500/30',
            cooldown: 'bg-blue-500/10 text-blue-400 border-blue-500/30',
            banned: 'bg-red-500/10 text-red-400 border-red-500/30',
            suspended: 'bg-orange-500/10 text-orange-400 border-orange-500/30',
            archived: 'bg-gray-500/10 text-gray-400 border-gray-500/30',
        }[status] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';
        return `<span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider border ${c}">${status}</span>`;
    }
    function typeBadge(type) {
        const c = { genesis: 'bg-green-500/10 text-green-400 border-green-500/30', switch: 'bg-blue-500/10 text-blue-400 border-blue-500/30', backup: 'bg-purple-500/10 text-purple-400 border-purple-500/30' }[type] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';
        return `<span class="px-1.5 py-0.5 rounded text-[9px] font-semibold uppercase border ${c}">${type}</span>`;
    }
    function stBadge(status) {
        const c = { success: 'bg-green-500/10 text-green-400 border-green-500/30', failed: 'bg-red-500/10 text-red-400 border-red-500/30', running: 'bg-amber-500/10 text-amber-400 border-amber-500/30' }[status] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';
        return `<span class="px-1.5 py-0.5 rounded text-[9px] font-semibold uppercase border ${c}">${status}</span>`;
    }

    function fmtNum(n) { if (!n) return '0'; if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'K'; return n.toString(); }
    function fmtBytes(b) { if (!b) return ''; if (b >= 1073741824) return (b/1073741824).toFixed(1)+' GB'; if (b >= 1048576) return (b/1048576).toFixed(1)+' MB'; if (b >= 1024) return (b/1024).toFixed(0)+' KB'; return b+' B'; }
    function fmtDate(iso) {
        if (!iso) return '—';
        try { const d = new Date(iso); return d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit'})+' '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}); } catch { return iso; }
    }

    function showToast(msg, type) {
        const el = document.getElementById('vault-toast');
        el.classList.remove('hidden');
        const colors = { success: 'bg-green-500/10 border border-green-500/30 text-green-400', error: 'bg-red-500/10 border border-red-500/30 text-red-400', warn: 'bg-amber-500/10 border border-amber-500/30 text-amber-400' };
        el.className = `mb-4 p-3 rounded-lg text-sm ${colors[type] || colors.warn}`;
        el.textContent = msg;
        setTimeout(() => el.classList.add('hidden'), 6000);
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('footer-clock').textContent =
            now.toLocaleTimeString('de-DE') + ' UTC' + (now.getTimezoneOffset() > 0 ? '-' : '+') + Math.abs(now.getTimezoneOffset() / 60);
    }

    // ===================================================================
    // Bulk Actions — Selection + API Calls
    // ===================================================================

    function getSelectedIds() {
        return Array.from(document.querySelectorAll('.profile-cb:checked')).map(cb => parseInt(cb.value));
    }

    function onProfileCheckChange() {
        updateBulkBar();
        // Update "select all" Checkbox
        const all = document.querySelectorAll('.profile-cb');
        const checked = document.querySelectorAll('.profile-cb:checked');
        const selectAllCb = document.getElementById('select-all-cb');
        if (all.length > 0 && checked.length === all.length) {
            selectAllCb.checked = true;
            selectAllCb.indeterminate = false;
        } else if (checked.length > 0) {
            selectAllCb.checked = false;
            selectAllCb.indeterminate = true;
        } else {
            selectAllCb.checked = false;
            selectAllCb.indeterminate = false;
        }

        // Highlight ausgewählte Zeilen
        document.querySelectorAll('.profile-cb').forEach(cb => {
            const row = cb.closest('tr');
            if (cb.checked) {
                row.classList.add('bg-indigo-900/10');
            } else {
                row.classList.remove('bg-indigo-900/10');
            }
        });
    }

    function toggleSelectAll(checked) {
        document.querySelectorAll('.profile-cb').forEach(cb => {
            cb.checked = checked;
            const row = cb.closest('tr');
            if (checked) row.classList.add('bg-indigo-900/10');
            else row.classList.remove('bg-indigo-900/10');
        });
        updateBulkBar();
    }

    function bulkSelectAll() {
        document.getElementById('select-all-cb').checked = true;
        toggleSelectAll(true);
    }

    function bulkDeselectAll() {
        document.getElementById('select-all-cb').checked = false;
        document.getElementById('select-all-cb').indeterminate = false;
        toggleSelectAll(false);
    }

    function updateBulkBar() {
        const ids = getSelectedIds();
        const bar = document.getElementById('bulk-bar');
        const countEl = document.getElementById('bulk-count');
        if (ids.length > 0) {
            bar.classList.remove('hidden');
            bar.classList.add('flex');
            countEl.textContent = ids.length;
        } else {
            bar.classList.add('hidden');
            bar.classList.remove('flex');
        }
    }

    async function bulkArchive() {
        const ids = getSelectedIds();
        if (ids.length === 0) return;
        if (!confirm(`${ids.length} Profile archivieren?`)) return;

        try {
            const res = await fetch('/api/vault/bulk/archive', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ profile_ids: ids }),
            });
            const data = await res.json();
            if (res.ok) {
                showToast(data.message, 'success');
                bulkDeselectAll();
                loadProfiles();
            } else {
                showToast(data.detail || 'Fehler', 'error');
            }
        } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
    }

    async function bulkUnarchive() {
        const ids = getSelectedIds();
        if (ids.length === 0) return;
        if (!confirm(`${ids.length} Profile wiederherstellen?`)) return;

        try {
            const res = await fetch('/api/vault/bulk/unarchive', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ profile_ids: ids }),
            });
            const data = await res.json();
            if (res.ok) {
                showToast(data.message, 'success');
                bulkDeselectAll();
                loadProfiles();
            } else {
                showToast(data.detail || 'Fehler', 'error');
            }
        } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
    }

    async function bulkDelete() {
        const ids = getSelectedIds();
        if (ids.length === 0) return;
        if (!confirm(`⚠ ${ids.length} Profile ENDGÜLTIG löschen?\n\nDies löscht auch die Identitäten falls keine anderen Profile sie nutzen.\n\nDiese Aktion kann NICHT rückgängig gemacht werden!`)) return;

        try {
            const res = await fetch('/api/vault/bulk/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ profile_ids: ids }),
            });
            const data = await res.json();
            if (res.ok) {
                showToast(data.message, 'success');
                bulkDeselectAll();
                loadProfiles();
            } else {
                showToast(data.detail || 'Fehler', 'error');
            }
        } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
    }

    async function bulkSetStatus() {
        const ids = getSelectedIds();
        const status = document.getElementById('bulk-status-select').value;
        if (ids.length === 0) return;
        if (!status) { showToast('Bitte einen Status auswählen.', 'warn'); return; }
        if (!confirm(`${ids.length} Profile auf "${status}" setzen?`)) return;

        try {
            const res = await fetch('/api/vault/bulk/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ profile_ids: ids, status: status }),
            });
            const data = await res.json();
            if (res.ok) {
                showToast(data.message, 'success');
                bulkDeselectAll();
                document.getElementById('bulk-status-select').value = '';
                loadProfiles();
            } else {
                showToast(data.detail || 'Fehler', 'error');
            }
        } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
    }

    // ===================================================================
    // Header: Device Status + Flow Polling
    // ===================================================================
    let vaultFlowPoll = null;

    // FIX-26: Polling-Guard
    let headerPollInProgress = false;
    async function refreshHeaderStatus() {
        if (headerPollInProgress) return;
        headerPollInProgress = true;
        try {
            const res = await fetch('/api/dashboard/stats');
            const data = await res.json();

            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            const rootEl = document.getElementById('header-root');
            const ipEl = document.getElementById('header-ip');

            if (data.adb_connected) {
                dot.className = 'w-2 h-2 rounded-full bg-green-500 pulse-dot';
                txt.textContent = 'Verbunden';
                txt.className = 'text-[11px] font-medium text-green-400';
            } else {
                dot.className = 'w-2 h-2 rounded-full bg-red-500';
                txt.textContent = 'Getrennt';
                txt.className = 'text-[11px] font-medium text-red-400';
            }

            if (data.root_access) {
                rootEl.textContent = 'Aktiv (KSU)';
                rootEl.className = 'text-[11px] font-medium text-green-400';
            } else {
                rootEl.textContent = '—';
                rootEl.className = 'text-[11px] font-medium text-gray-500';
            }

            if (data.public_ip) {
                ipEl.textContent = data.public_ip;
                ipEl.className = 'text-[11px] font-mono font-medium text-cyan-400';
            } else {
                ipEl.textContent = '—';
                ipEl.className = 'text-[11px] font-mono font-medium text-gray-500';
            }

            // DNA Identity Header
            const dnaEl = document.getElementById('header-dna');
            if (dnaEl) {
                if (data.active_identity && data.dna_match && data.dna_match !== 'db_only') {
                    const headerDnaColors = {
                        'exact': 'text-emerald-400',
                        'strong': 'text-cyan-400',
                        'partial': 'text-yellow-400',
                    };
                    const headerDnaIcons = {
                        'exact': '✓ ',
                        'strong': '✓ ',
                        'partial': '~ ',
                    };
                    dnaEl.textContent = (headerDnaIcons[data.dna_match] || '') + data.active_identity.name;
                    dnaEl.className = 'text-[11px] font-mono font-medium ' + (headerDnaColors[data.dna_match] || 'text-gray-400');
                } else if (data.active_identity && data.dna_match === 'db_only') {
                    dnaEl.textContent = '⚠ ' + data.active_identity.name + ' (DB)';
                    dnaEl.className = 'text-[11px] font-mono font-medium text-orange-400';
                } else if (data.adb_connected) {
                    dnaEl.textContent = '✗ Unbekannt';
                    dnaEl.className = 'text-[11px] font-mono font-medium text-red-400';
                } else {
                    dnaEl.textContent = '—';
                    dnaEl.className = 'text-[11px] font-mono font-medium text-gray-500';
                }
            }
        } catch (e) {
        } finally {
            headerPollInProgress = false;
        }
    }

    // FIX-26: Polling-Guard
    let flowPollInProgress = false;
    async function pollFlowForHeader() {
        if (flowPollInProgress) return;
        flowPollInProgress = true;
        try {
            const res = await fetch('/api/control/status');
            const data = await res.json();

            const badge = document.getElementById('flow-badge');
            const idle = document.getElementById('flow-idle');
            const badgeText = document.getElementById('flow-badge-text');

            if (data.running) {
                badge.classList.remove('hidden');
                badge.classList.add('flex');
                idle.classList.add('hidden');
                badgeText.textContent = data.flow_type ? data.flow_type.toUpperCase() + ' aktiv' : 'Flow aktiv';
            } else {
                badge.classList.add('hidden');
                badge.classList.remove('flex');
                idle.classList.remove('hidden');
            }
        } catch (e) {
        } finally {
            flowPollInProgress = false;
        }
    }

    async function headerAbortFlow() {
        if (!confirm('Flow wirklich abbrechen?\n\nDer laufende Prozess wird sofort gestoppt.')) return;
        try {
            await fetch('/api/control/abort', {method: 'POST'});
            showToast('Flow abgebrochen.', 'warn');
            pollFlowForHeader();
        } catch (e) {
            showToast('Fehler: ' + e.message, 'error');
        }
    }

    // ===================================================================
    // Init
    // ===================================================================
    document.addEventListener('DOMContentLoaded', () => {
        loadProfiles();
        refreshHeaderStatus();
        pollFlowForHeader();
        updateClock();
        setInterval(updateClock, 1000);
        setInterval(refreshHeaderStatus, 5000);
        setInterval(pollFlowForHeader, 3000);
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeCreateModal(); closeEditModal(); closeDetailModal(); }
    });
</script>
</body>
</html>
