<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-950">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Manager</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: {
                            50:  '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0',
                            300: '#86efac', 400: '#4ade80', 500: '#22c55e',
                            600: '#16a34a', 700: '#15803d', 800: '#166534',
                            900: '#14532d', 950: '#052e16',
                        }
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Terminal Styling */
        #log-terminal {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        #log-terminal .log-info  { color: #a3e635; }
        #log-terminal .log-warn  { color: #facc15; }
        #log-terminal .log-error { color: #f87171; }
        #log-terminal .log-debug { color: #94a3b8; }
        #log-terminal .log-ts    { color: #64748b; }
        #log-terminal .log-name  { color: #67e8f9; }

        /* Pulse Animation */
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        /* Collapse/Expand */
        .animate-fadeIn {
            animation: fadeIn 0.15s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }

        /* HTMX Loading Indicator */
        .htmx-request .btn-label { display: none; }
        .htmx-request .btn-loading { display: inline-flex; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
    </style>
</head>
<body class="h-full text-gray-100 antialiased">

<div class="min-h-full flex flex-col">

    <!-- =============================================================== -->
    <!-- HEADER -->
    <!-- =============================================================== -->
    <header class="bg-gray-900/80 backdrop-blur-sm border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14">

                <!-- LEFT: Device Status -->
                <div class="flex items-center gap-4">
                    <!-- Device Status Bar -->
                    <div class="flex items-center gap-3">
                        <!-- ADB -->
                        <div class="flex items-center gap-1.5">
                            <span class="text-[10px] text-gray-600 uppercase">ADB</span>
                            <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-600"></div>
                            <span id="status-text" class="text-[11px] font-medium text-gray-500">—</span>
                        </div>
                        <!-- Root -->
                        <div class="flex items-center gap-1.5">
                            <span class="text-[10px] text-gray-600 uppercase">Root</span>
                            <span id="header-root" class="text-[11px] font-medium text-gray-500">—</span>
                        </div>
                        <!-- Public IP -->
                        <div class="flex items-center gap-1.5">
                            <span class="text-[10px] text-gray-600 uppercase">IP</span>
                            <span id="header-ip" class="text-[11px] font-mono font-medium text-gray-500">—</span>
                        </div>
                        <!-- DNA Identity -->
                        <div class="flex items-center gap-1.5">
                            <span class="text-[10px] text-gray-600 uppercase">DNA</span>
                            <span id="header-dna" class="text-[11px] font-mono font-medium text-gray-500">—</span>
                        </div>
                    </div>

                    <!-- Separator -->
                    <div class="w-px h-6 bg-gray-800"></div>

                    <!-- Flow Status -->
                    <div id="flow-badge" class="hidden items-center gap-2">
                        <svg class="w-3 h-3 text-amber-400 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <span id="flow-badge-text" class="text-[11px] font-semibold text-amber-400">Flow aktiv</span>
                        <button id="header-abort-btn" onclick="headerAbortFlow()"
                                class="ml-1 p-1 rounded bg-red-600/20 border border-red-600/30 hover:bg-red-600/30 transition-all"
                                title="Flow abbrechen">
                            <svg class="w-3 h-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div id="flow-idle" class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-gray-700"></div>
                        <span class="text-[10px] text-gray-600">Kein Flow</span>
                    </div>
                </div>

                <!-- RIGHT: Navigation + Tools -->
                <nav class="flex items-center gap-1">
                    <!-- USB Cycle / ADB Reconnect -->
                    <button id="btn-adb-reconnect"
                            onclick="adbReconnect()"
                            title="USB-Kabel simulieren: Trennt USB-C am Gerät und steckt es wieder ein"
                            class="px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all
                                   border border-gray-700 bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700
                                   disabled:opacity-40 disabled:cursor-not-allowed">
                        <div class="flex items-center gap-1.5">
                            <svg id="adb-reconnect-icon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            <svg id="adb-reconnect-spinner" class="w-3.5 h-3.5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            <span id="adb-reconnect-label">USB</span>
                        </div>
                    </button>

                    <!-- scrcpy Toggle -->
                    <button id="btn-scrcpy"
                            onclick="toggleScrcpy()"
                            title="Screen Mirroring (scrcpy)"
                            class="px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all
                                   border border-gray-700 bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700">
                        <div class="flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            <span id="scrcpy-label">Mirror</span>
                        </div>
                    </button>

                    <!-- Separator -->
                    <div class="w-px h-5 bg-gray-800 mx-0.5"></div>

                    <a href="/"
                       class="px-3 py-1.5 rounded-lg text-xs font-medium text-white bg-gray-800 border border-gray-700">
                        Dashboard
                    </a>
                    <a href="/vault"
                       class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-all">
                        Vault
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <!-- =============================================================== -->
    <!-- MAIN CONTENT -->
    <!-- =============================================================== -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- =============================================================== -->
        <!-- COMBINED CARD: Active Identity + Actions -->
        <!-- =============================================================== -->
        <div class="bg-gray-900/50 border border-gray-800 rounded-xl p-5">

            <!-- TOP: Active Identity (klickbar → Popup) -->
            <div id="identity-card" class="mb-4">
                <div class="text-center py-4 text-gray-600">
                    <p class="text-sm">Keine aktive Identität</p>
                </div>
            </div>

            <!-- Separator -->
            <div class="border-t border-gray-800 mb-4"></div>

            <!-- BOTTOM: Actions (Genesis + Switch nebeneinander) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <!-- Genesis -->
                <div class="space-y-2">
                    <input type="text" id="genesis-name" placeholder="Identity Name (z.B. DE_Berlin_001)"
                           class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-200
                                  placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-accent-500/50 focus:border-accent-500">
                    <label class="flex items-center gap-2 text-xs text-gray-400 cursor-pointer select-none pl-1">
                        <input type="checkbox" id="genesis-backup"
                               class="w-3.5 h-3.5 rounded border-gray-600 bg-gray-800 text-cyan-500
                                      focus:ring-cyan-500/30 focus:ring-offset-0 cursor-pointer">
                        <span>Aktives Profil vorher sichern</span>
                    </label>
                    <button id="btn-genesis"
                            onclick="startGenesis()"
                            class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg
                                   bg-gradient-to-r from-accent-600 to-emerald-600
                                   hover:from-accent-500 hover:to-emerald-500
                                   text-white font-semibold text-sm
                                   transition-all duration-200 shadow-lg shadow-accent-500/20
                                   disabled:opacity-40 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span class="btn-label">GENESIS</span>
                        <span class="btn-loading hidden items-center gap-2">
                            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            Läuft...
                        </span>
                    </button>
                </div>

                <!-- Switch -->
                <div class="space-y-2">
                    <select id="switch-id"
                            class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-200
                                   focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500">
                        <option value="">— Identity auswählen —</option>
                    </select>
                    <button id="btn-switch"
                            onclick="startSwitch()"
                            class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg
                                   bg-gradient-to-r from-blue-600 to-indigo-600
                                   hover:from-blue-500 hover:to-indigo-500
                                   text-white font-semibold text-sm
                                   transition-all duration-200 shadow-lg shadow-blue-500/20
                                   disabled:opacity-40 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                        </svg>
                        <span class="btn-label">SWITCH</span>
                        <span class="btn-loading hidden items-center gap-2">
                            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            Läuft...
                        </span>
                    </button>
                </div>
            </div>

            <!-- Abort Button (volle Breite unter beiden) -->
            <button id="btn-abort"
                    onclick="abortFlow()"
                    class="hidden w-full mt-3 flex items-center justify-center gap-2 px-3 py-2 rounded-lg
                           bg-red-600/20 border border-red-600/40 hover:bg-red-600/30
                           text-red-400 font-medium text-xs transition-all">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                ABORT
            </button>

            <!-- Flow Result Toast -->
            <div id="flow-result" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
        </div>

        <!-- =============================================================== -->
        <!-- GRID: Identity Vault + Flow History -->
        <!-- =============================================================== -->
        <div class="mt-5 grid grid-cols-1 xl:grid-cols-2 gap-5">

            <!-- Identity Vault -->
            <div class="bg-gray-900/50 border border-gray-800 rounded-xl overflow-hidden">
                <div class="flex items-center justify-between px-5 py-3 border-b border-gray-800">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                        <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Identity Vault</h2>
                        <span id="vault-count" class="text-xs text-gray-600 ml-1">(0)</span>
                    </div>
                    <button onclick="loadVault()" class="text-xs text-accent-400 hover:text-accent-300 transition-colors">Refresh</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-xs text-gray-500 uppercase tracking-wider bg-gray-900/30">
                                <th class="px-4 py-2 font-medium">ID</th>
                                <th class="px-4 py-2 font-medium">Name</th>
                                <th class="px-4 py-2 font-medium">Status</th>
                                <th class="px-4 py-2 font-medium">Backups</th>
                                <th class="px-4 py-2 font-medium">IP</th>
                                <th class="px-4 py-2 font-medium text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="vault-body" class="divide-y divide-gray-800/50">
                            <tr>
                                <td colspan="6" class="px-4 py-6 text-center text-gray-600 text-sm">
                                    Keine Identitäten im Vault
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Flow History -->
            <div class="bg-gray-900/50 border border-gray-800 rounded-xl overflow-hidden">
                <div class="flex items-center justify-between px-5 py-3 border-b border-gray-800">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Flow History</h2>
                        <span id="flow-history-count" class="text-xs text-gray-600 ml-1">(0)</span>
                    </div>
                    <button onclick="loadFlowHistory()" class="text-xs text-amber-400 hover:text-amber-300 transition-colors">Refresh</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-xs text-gray-500 uppercase tracking-wider bg-gray-900/30">
                                <th class="px-4 py-2 font-medium w-10">ID</th>
                                <th class="px-4 py-2 font-medium">Type</th>
                                <th class="px-4 py-2 font-medium">Status</th>
                                <th class="px-4 py-2 font-medium">Identity</th>
                                <th class="px-4 py-2 font-medium">Duration</th>
                                <th class="px-4 py-2 font-medium">Time</th>
                            </tr>
                        </thead>
                        <tbody id="flow-history-body" class="divide-y divide-gray-800/50">
                            <tr><td colspan="6" class="px-4 py-6 text-center text-gray-600 text-sm">Lade Flow-History...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- =============================================================== -->
    <!-- MODAL: Identity Detail -->
    <!-- =============================================================== -->
    <div id="identity-detail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center"
         style="background:rgba(0,0,0,.6);backdrop-filter:blur(4px);">
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800 sticky top-0 bg-gray-900 z-10">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-white" id="detail-title">Identity Detail</h3>
                        <p class="text-[10px] text-gray-500" id="detail-subtitle"></p>
                    </div>
                </div>
                <button onclick="closeDetailModal()" class="text-gray-500 hover:text-white transition-colors p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <!-- Body -->
            <div id="detail-body" class="p-6 space-y-5">
                <div class="text-center py-8 text-gray-600 text-sm">Lade...</div>
            </div>
        </div>
    </div>

    <!-- =============================================================== -->
    <!-- MODAL: Active Identity Popup -->
    <!-- =============================================================== -->
    <div id="active-id-popup" class="hidden fixed inset-0 z-50 flex items-center justify-center"
         style="background:rgba(0,0,0,.6);backdrop-filter:blur(4px);"
         onclick="if(event.target===this)closeActiveIdPopup()">
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[85vh] overflow-y-auto animate-fadeIn">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-3.5 border-b border-gray-800 sticky top-0 bg-gray-900 z-10">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-accent-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0"/>
                    </svg>
                    <h3 class="text-sm font-semibold text-white" id="active-id-popup-title">Active Identity</h3>
                </div>
                <button onclick="closeActiveIdPopup()" class="text-gray-500 hover:text-white transition-colors p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <!-- Body -->
            <div id="active-id-popup-body" class="p-5 space-y-3"></div>
        </div>
    </div>

    <!-- =============================================================== -->
    <!-- FOOTER -->
    <!-- =============================================================== -->
    <footer class="border-t border-gray-800/50 py-3">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between">
            <p class="text-[10px] text-gray-700">Device Manager v1.0.0</p>
            <p class="text-[10px] text-gray-700" id="footer-clock"></p>
        </div>
    </footer>
</div>

<!-- =============================================================== -->
<!-- LIVE LOGS: Fixed Overlay unten links (aufklappbar) -->
<!-- =============================================================== -->
<div id="log-panel" class="fixed bottom-4 left-4 z-40 flex flex-col"
     style="width:480px; max-width:calc(100vw - 2rem);">

    <!-- Log Body (default: sichtbar) -->
    <div id="log-panel-body" class="bg-gray-950 border border-gray-800 rounded-xl shadow-2xl overflow-hidden transition-all duration-200"
         style="max-height:320px;">
        <!-- Header -->
        <div class="flex items-center justify-between px-3 py-2 border-b border-gray-800 bg-gray-900 cursor-pointer select-none"
             onclick="toggleLogPanel()">
            <div class="flex items-center gap-2">
                <div class="flex gap-1">
                    <div class="w-2.5 h-2.5 rounded-full bg-red-500/80"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/80"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-green-500/80"></div>
                </div>
                <span class="text-[11px] font-medium text-gray-400 ml-1">Live Logs</span>
                <div id="ws-indicator" class="w-1.5 h-1.5 rounded-full bg-gray-600 ml-1"></div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="event.stopPropagation(); clearLogs()" class="text-[10px] text-gray-600 hover:text-gray-400 transition-colors">Clear</button>
                <svg id="log-panel-chevron" class="w-3.5 h-3.5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>
        <!-- Terminal -->
        <div id="log-terminal" class="h-64 overflow-y-auto px-3 py-2 space-y-0.5">
            <div class="text-gray-600 text-xs">Warte auf Verbindung...</div>
        </div>
    </div>
</div>

<!-- =============================================================== -->
<!-- JAVASCRIPT -->
<!-- =============================================================== -->
<script>
    // ===================================================================
    // Config
    // ===================================================================
    const WS_URL = `ws://${location.host}/ws/logs`;
    // v5.0: Adaptives Polling — Backend cacht ADB-Daten für 30s im Idle,
    // also reicht ein langsamerer Poll wenn kein Flow aktiv ist.
    const POLL_INTERVAL_IDLE_MS = 5000;    // 5s wenn kein Flow
    const POLL_INTERVAL_ACTIVE_MS = 2000;  // 2s wenn Flow läuft
    let POLL_INTERVAL_MS = POLL_INTERVAL_IDLE_MS;
    const STATUS_POLL_MS = 2000;

    let ws = null;
    let statusPoll = null;
    let flowRunning = false;

    // Active Identity Popup-Daten (gesetzt in refreshStats)
    window._activeIdentityData = null;

    // ===================================================================
    // WebSocket: Live Logs
    // ===================================================================
    function connectWS() {
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
            document.getElementById('ws-indicator').classList.replace('bg-gray-600', 'bg-green-500');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'pong') return;
            appendLog(data);
        };

        ws.onclose = () => {
            document.getElementById('ws-indicator').classList.replace('bg-green-500', 'bg-gray-600');
            // Reconnect nach 3s
            setTimeout(connectWS, 3000);
        };

        ws.onerror = () => { ws.close(); };
    }

    function appendLog(entry) {
        const terminal = document.getElementById('log-terminal');
        const line = document.createElement('div');
        const levelClass = {
            'INFO': 'log-info', 'WARNING': 'log-warn',
            'ERROR': 'log-error', 'DEBUG': 'log-debug',
        }[entry.level] || 'log-info';

        line.innerHTML = `<span class="log-ts">${entry.ts}</span> <span class="log-name">[${entry.name}]</span> <span class="${levelClass}">${escapeHtml(entry.msg)}</span>`;
        terminal.appendChild(line);

        // Auto-scroll
        terminal.scrollTop = terminal.scrollHeight;

        // Max 500 Zeilen
        while (terminal.children.length > 500) {
            terminal.removeChild(terminal.firstChild);
        }
    }

    function clearLogs() {
        document.getElementById('log-terminal').innerHTML = '';
    }

    // ===================================================================
    // Dashboard: Stats Polling
    // ===================================================================
    // FIX-26: Polling-Guard
    let refreshStatsInProgress = false;
    async function refreshStats() {
        if (refreshStatsInProgress) return;
        refreshStatsInProgress = true;
        try {
            const res = await fetch('/api/dashboard/stats');
            const data = await res.json();

            // === Header: Device Status ===
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            const rootEl = document.getElementById('header-root');
            const ipEl = document.getElementById('header-ip');

            if (data.adb_connected) {
                dot.className = 'w-2 h-2 rounded-full bg-green-500 pulse-dot';
                txt.textContent = 'Verbunden';
                txt.className = 'text-[11px] font-medium text-green-400';
            } else {
                dot.className = 'w-2 h-2 rounded-full bg-red-500';
                txt.textContent = 'Getrennt';
                txt.className = 'text-[11px] font-medium text-red-400';
            }

            // Root
            if (data.root_access) {
                rootEl.textContent = 'Aktiv (KSU)';
                rootEl.className = 'text-[11px] font-medium text-green-400';
            } else {
                rootEl.textContent = '—';
                rootEl.className = 'text-[11px] font-medium text-gray-500';
            }

            // Public IP
            if (data.public_ip) {
                ipEl.textContent = data.public_ip;
                ipEl.className = 'text-[11px] font-mono font-medium text-cyan-400';
            } else {
                ipEl.textContent = '—';
                ipEl.className = 'text-[11px] font-mono font-medium text-gray-500';
            }

            // DNA Identity Header
            const dnaEl = document.getElementById('header-dna');
            if (data.active_identity && data.dna_match && data.dna_match !== 'db_only') {
                const headerDnaColors = {
                    'exact': 'text-emerald-400',
                    'strong': 'text-cyan-400',
                    'partial': 'text-yellow-400',
                };
                const headerDnaIcons = {
                    'exact': '✓ ',
                    'strong': '✓ ',
                    'partial': '~ ',
                };
                dnaEl.textContent = (headerDnaIcons[data.dna_match] || '') + data.active_identity.name;
                dnaEl.className = 'text-[11px] font-mono font-medium ' + (headerDnaColors[data.dna_match] || 'text-gray-400');
            } else if (data.active_identity && data.dna_match === 'db_only') {
                dnaEl.textContent = '⚠ ' + data.active_identity.name + ' (DB)';
                dnaEl.className = 'text-[11px] font-mono font-medium text-orange-400';
            } else if (data.adb_connected && data.bridge_loaded) {
                dnaEl.textContent = '✗ Unbekannt';
                dnaEl.className = 'text-[11px] font-mono font-medium text-red-400';
            } else if (data.adb_connected) {
                dnaEl.textContent = '— Keine Bridge';
                dnaEl.className = 'text-[11px] font-mono font-medium text-gray-500';
            } else {
                dnaEl.textContent = '—';
                dnaEl.className = 'text-[11px] font-mono font-medium text-gray-500';
            }

            // Active Identity Card — speichere Daten für Popup
            // Speichere aktuelle Identity-Daten für Popup
            window._activeIdentityData = data.active_identity ? { ...data.active_identity, dna_match: data.dna_match, dna_synced: data.dna_synced, dna_matched_fields: data.dna_matched_fields || [], bridge_values: data.bridge_values || {}, bridge_loaded: data.bridge_loaded } : null;

            const idEl = document.getElementById('identity-card');
            if (data.active_identity) {
                const id = data.active_identity;
                const dnaMatch = data.dna_match;

                // Kompakter DNA-Badge für die Karte
                const dnaBadgeMap = {
                    'exact':   { cls: 'bg-emerald-500/15 text-emerald-400 border-emerald-500/30', label: 'DNA MATCH' },
                    'strong':  { cls: 'bg-cyan-500/15 text-cyan-400 border-cyan-500/30', label: 'STRONG' },
                    'partial': { cls: 'bg-yellow-500/15 text-yellow-400 border-yellow-500/30', label: 'PARTIAL' },
                    'db_only': { cls: 'bg-orange-500/15 text-orange-400 border-orange-500/30', label: 'DB ONLY' },
                };
                const badge = dnaBadgeMap[dnaMatch];
                const dnaBadgeHtml = badge
                    ? `<span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider border ${badge.cls}">${badge.label}</span>`
                    : '';

                idEl.innerHTML = `
                    <div class="cursor-pointer select-none group" onclick="openActiveIdentityPopup()">
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-bold text-accent-400 group-hover:text-accent-300 transition-colors">${escapeHtml(id.name)}</span>
                            <div class="flex items-center gap-2">
                                ${dnaBadgeHtml}
                                <span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider
                                             bg-accent-500/10 text-accent-400 border border-accent-500/30">${id.status}</span>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-600 mt-1 group-hover:text-gray-400 transition-colors">Klicken für Details</p>
                    </div>
                `;
            } else if (data.adb_connected && data.bridge_loaded) {
                // Bridge gelesen, aber kein DB-Match → unbekannte Identity
                const bv2 = data.bridge_values || {};
                idEl.innerHTML = `
                    <div class="text-center py-4">
                        <div class="inline-flex items-center gap-1 px-2 py-1 rounded bg-red-500/10 border border-red-500/20 text-red-400 text-xs mb-3">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            UNBEKANNTE IDENTITY
                        </div>
                        <p class="text-[10px] text-gray-600 mb-2">Bridge-Datei vorhanden, aber kein Match in der DB</p>
                        ${bv2.serial ? `<p class="text-xs text-gray-500">Serial: <span class="font-mono text-gray-400">${escapeHtml(bv2.serial)}</span></p>` : ''}
                        ${bv2.imei1 ? `<p class="text-xs text-gray-500">IMEI: <span class="font-mono text-gray-400">${escapeHtml(bv2.imei1)}</span></p>` : ''}
                        ${bv2.android_id ? `<p class="text-xs text-gray-500">Android ID: <span class="font-mono text-gray-400">${escapeHtml(bv2.android_id)}</span></p>` : ''}
                        <p class="text-[10px] text-gray-600 mt-2">Starte einen Genesis-Flow um eine neue Identity anzulegen.</p>
                    </div>`;
            } else if (data.adb_connected) {
                // Gerät verbunden, aber keine Bridge-Datei
                idEl.innerHTML = `
                    <div class="text-center py-4">
                        <div class="inline-flex items-center gap-1 px-2 py-1 rounded bg-yellow-500/10 border border-yellow-500/20 text-yellow-400 text-xs mb-3">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                            KEINE BRIDGE-DATEI
                        </div>
                        <p class="text-xs text-gray-500 mb-1">Serial: <span class="font-mono text-gray-400">${escapeHtml(data.device_serial || '—')}</span></p>
                        <p class="text-[10px] text-gray-600 mt-2">Kein Bridge-File auf dem Gerät.<br>Starte einen Genesis-Flow.</p>
                    </div>`;
            } else {
                idEl.innerHTML = '<div class="text-center py-6 text-gray-600"><p class="text-sm">Keine aktive Identität</p><p class="text-xs mt-1">Starte einen Genesis-Flow</p></div>';
            }
        } catch (e) {
            console.error('Stats refresh error:', e);
        } finally {
            refreshStatsInProgress = false;
        }
    }

    // ===================================================================
    // Flow Control
    // ===================================================================
    async function startGenesis() {
        const name = document.getElementById('genesis-name').value.trim();
        if (!name) {
            showResult('Bitte einen Namen eingeben.', 'warn');
            return;
        }

        const backupBefore = document.getElementById('genesis-backup').checked;

        const btn = document.getElementById('btn-genesis');
        btn.disabled = true;

        try {
            const res = await fetch('/api/control/genesis', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name, backup_before: backupBefore}),
            });
            const data = await res.json();

            if (res.ok) {
                showResult(data.message, 'success');
                startFlowPolling();
            } else {
                showResult(data.detail || 'Fehler', 'error');
                btn.disabled = false;
            }
        } catch (e) {
            showResult('Netzwerkfehler: ' + e.message, 'error');
            btn.disabled = false;
        }
    }

    async function startSwitch() {
        const id = document.getElementById('switch-id').value;
        if (!id) {
            showResult('Bitte eine Identity auswählen.', 'warn');
            return;
        }

        const btn = document.getElementById('btn-switch');
        btn.disabled = true;

        // Versuche den Identity-Namen als Profil-Name zu verwenden (Full-State)
        // Falls kein Profil-Backup existiert, fällt der Flow automatisch auf Legacy zurück
        let profileName = null;
        try {
            const idRes = await fetch('/api/dashboard/identities');
            const idData = await idRes.json();
            const identity = (idData.identities || []).find(i => i.id === parseInt(id));
            if (identity) profileName = identity.name;
        } catch(e) { /* ignore */ }

        try {
            const body = profileName
                ? { profile_name: profileName }
                : {};

            const res = await fetch(`/api/control/switch/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body),
            });
            const data = await res.json();

            if (res.ok) {
                showResult(data.message, 'success');
                startFlowPolling();
            } else {
                showResult(data.detail || 'Fehler', 'error');
                btn.disabled = false;
            }
        } catch (e) {
            showResult('Netzwerkfehler: ' + e.message, 'error');
            btn.disabled = false;
        }
    }

    async function abortFlow() {
        try {
            await fetch('/api/control/abort', {method: 'POST'});
            showResult('Flow abgebrochen.', 'warn');
            stopFlowPolling();
        } catch (e) {
            console.error('Abort error:', e);
        }
    }

    // ===================================================================
    // Flow Status Polling
    // ===================================================================
    function startFlowPolling() {
        flowRunning = true;
        if (window._adjustPollRate) window._adjustPollRate(true);  // Schnellerer Poll
        document.getElementById('btn-genesis').disabled = true;
        document.getElementById('btn-switch').disabled = true;
        document.getElementById('btn-abort').classList.remove('hidden');
        document.getElementById('btn-abort').classList.add('flex');
        // Header: Flow-Badge zeigen, Idle verstecken
        document.getElementById('flow-badge').classList.remove('hidden');
        document.getElementById('flow-badge').classList.add('flex');
        document.getElementById('flow-idle').classList.add('hidden');

        statusPoll = setInterval(pollFlowStatus, STATUS_POLL_MS);
    }

    function stopFlowPolling() {
        flowRunning = false;
        if (window._adjustPollRate) window._adjustPollRate(false);  // Langsamerer Poll
        if (statusPoll) clearInterval(statusPoll);
        statusPoll = null;
        document.getElementById('btn-genesis').disabled = false;
        document.getElementById('btn-switch').disabled = false;
        document.getElementById('btn-abort').classList.add('hidden');
        document.getElementById('btn-abort').classList.remove('flex');
        // Header: Flow-Badge verstecken, Idle zeigen
        document.getElementById('flow-badge').classList.add('hidden');
        document.getElementById('flow-badge').classList.remove('flex');
        document.getElementById('flow-idle').classList.remove('hidden');
    }

    async function headerAbortFlow() {
        if (!confirm('Flow wirklich abbrechen?\n\nDer laufende Prozess wird sofort gestoppt.')) return;
        try {
            await fetch('/api/control/abort', {method: 'POST'});
            showResult('Flow abgebrochen.', 'warn');
            stopFlowPolling();
        } catch (e) {
            console.error('Abort error:', e);
        }
    }

    // FIX-26: Polling-Guard gegen Race-Conditions
    let pollFlowInProgress = false;
    async function pollFlowStatus() {
        if (pollFlowInProgress) return;
        pollFlowInProgress = true;
        try {
            const res = await fetch('/api/control/status');
            const data = await res.json();

            document.getElementById('flow-badge-text').textContent =
                data.flow_type ? data.flow_type.toUpperCase() + ' aktiv' : 'Flow aktiv';

            if (!data.running && flowRunning) {
                // Flow beendet
                stopFlowPolling();
                refreshStats();
                loadVault();
                loadFlowHistory();

                if (data.result && data.result.success) {
                    showResult('Flow erfolgreich abgeschlossen!', 'success');
                } else {
                    showResult('Flow fehlgeschlagen: ' + (data.error || 'Unbekannter Fehler'), 'error');
                }
            }
        } catch (e) {
            console.error('Status poll error:', e);
        } finally {
            pollFlowInProgress = false;
        }
    }

    // ===================================================================
    // Vault (Identities List)
    // ===================================================================
    async function loadVault() {
        try {
            const res = await fetch('/api/dashboard/identities');
            const data = await res.json();
            const tbody = document.getElementById('vault-body');
            const count = document.getElementById('vault-count');

            const identities = data.identities || [];
            count.textContent = `(${identities.length})`;

            // Switch-Dropdown befüllen
            const sel = document.getElementById('switch-id');
            const prevVal = sel.value;
            sel.innerHTML = '<option value="">— Identity auswählen —</option>' +
                identities.map(id => {
                    const ds = id.profile_status || id.status;
                    const isActive = ds === 'active';
                    const displayName = id.profile_name || id.name;
                    return `<option value="${id.id}" ${isActive ? 'class="text-green-400"' : ''}>`
                        + `#${id.id} — ${escapeHtml(displayName)}`
                        + (isActive ? ' (aktiv)' : '')
                        + `</option>`;
                }).join('');
            if (prevVal) sel.value = prevVal;

            if (identities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-600 text-sm">Keine Identitäten im Vault</td></tr>';
                return;
            }

            tbody.innerHTML = identities.map(id => {
                const displayStatus = id.profile_status || id.status;
                const isActive = displayStatus === 'active';
                const displayName = id.profile_name || id.name;

                // Backup-Badges
                const bkps = [];
                if (id.backup_status === 'valid') bkps.push('<span class="px-1 py-0.5 rounded text-[9px] bg-pink-500/10 text-pink-400 border border-pink-500/30">TT</span>');
                if (id.gms_backup_status === 'valid') bkps.push('<span class="px-1 py-0.5 rounded text-[9px] bg-blue-500/10 text-blue-400 border border-blue-500/30">GMS</span>');
                if (id.accounts_backup_status === 'valid') bkps.push('<span class="px-1 py-0.5 rounded text-[9px] bg-cyan-500/10 text-cyan-400 border border-cyan-500/30">ACC</span>');
                const bkpStr = bkps.length > 0 ? bkps.join(' ') : '<span class="text-gray-600 text-[10px]">none</span>';

                return `
                <tr class="hover:bg-gray-800/30 transition-colors group cursor-pointer" onclick="openIdentityDetail(${id.id})">
                    <td class="px-4 py-2 font-mono text-xs text-gray-500">#${id.id}</td>
                    <td class="px-4 py-2 font-medium text-gray-200 text-xs">${escapeHtml(displayName)}</td>
                    <td class="px-4 py-2">${statusBadge(displayStatus)}</td>
                    <td class="px-4 py-2">${bkpStr}</td>
                    <td class="px-4 py-2 font-mono text-xs text-gray-500">${id.last_public_ip || '—'}</td>
                    <td class="px-4 py-2 text-right">
                        <button onclick="event.stopPropagation(); quickSwitch(${id.id})"
                                class="opacity-0 group-hover:opacity-100 px-2 py-0.5 rounded text-[10px] font-medium
                                       bg-blue-600/20 text-blue-400 border border-blue-600/30 hover:bg-blue-600/30
                                       transition-all duration-200"
                                ${isActive ? 'disabled' : ''}>
                            Load
                        </button>
                    </td>
                </tr>`;
            }).join('');
        } catch (e) {
            console.error('Vault load error:', e);
        }
    }

    function quickSwitch(id) {
        document.getElementById('switch-id').value = id;
        startSwitch();
    }

    // ===================================================================
    // Flow History
    // ===================================================================
    async function loadFlowHistory() {
        try {
            const res = await fetch('/api/dashboard/flow-history?limit=20');
            const data = await res.json();
            const tbody = document.getElementById('flow-history-body');
            const count = document.getElementById('flow-history-count');

            const flows = data.flows || [];
            count.textContent = `(${flows.length})`;

            if (flows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-600 text-sm">Noch keine Flows ausgeführt</td></tr>';
                return;
            }

            tbody.innerHTML = flows.map(f => {
                const typeBadge = {
                    genesis: 'bg-accent-500/10 text-accent-400 border-accent-500/30',
                    switch:  'bg-blue-500/10 text-blue-400 border-blue-500/30',
                    backup:  'bg-purple-500/10 text-purple-400 border-purple-500/30',
                }[f.flow_type] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';

                const statusBg = {
                    success: 'bg-green-500/10 text-green-400 border-green-500/30',
                    failed:  'bg-red-500/10 text-red-400 border-red-500/30',
                    running: 'bg-amber-500/10 text-amber-400 border-amber-500/30',
                    aborted: 'bg-gray-500/10 text-gray-400 border-gray-500/30',
                }[f.status] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';

                const durStr = f.duration_ms ? (f.duration_ms / 1000).toFixed(1) + 's' : '—';

                return `<tr class="hover:bg-gray-800/30 transition-colors">
                    <td class="px-4 py-2 font-mono text-xs text-gray-500">#${f.id}</td>
                    <td class="px-4 py-2"><span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase border ${typeBadge}">${f.flow_type}</span></td>
                    <td class="px-4 py-2"><span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase border ${statusBg}">${f.status}</span></td>
                    <td class="px-4 py-2 font-mono text-xs text-gray-400 truncate max-w-[120px]">${f.generated_serial || (f.identity_id ? '#' + f.identity_id : '—')}</td>
                    <td class="px-4 py-2 font-mono text-xs text-gray-500">${durStr}</td>
                    <td class="px-4 py-2 text-xs text-gray-500">${formatDate(f.started_at)}</td>
                </tr>`;
            }).join('');
        } catch (e) {
            console.error('Flow history load error:', e);
        }
    }

    // ===================================================================
    // Active Identity Popup
    // ===================================================================
    function openActiveIdentityPopup() {
        const d = window._activeIdentityData;
        if (!d) return;

        const modal = document.getElementById('active-id-popup');
        const title = document.getElementById('active-id-popup-title');
        const body  = document.getElementById('active-id-popup-body');

        title.textContent = d.name;

        // DNA Badge
        const dnaMap = {
            'exact':   { cls: 'bg-emerald-500/15 text-emerald-400 border-emerald-500/30', label: '✓ Exakt (Bridge ↔ DB)' },
            'strong':  { cls: 'bg-cyan-500/15 text-cyan-400 border-cyan-500/30', label: '✓ Stark' },
            'partial': { cls: 'bg-yellow-500/15 text-yellow-400 border-yellow-500/30', label: '~ Teilweise' },
            'db_only': { cls: 'bg-orange-500/15 text-orange-400 border-orange-500/30', label: '⚠ Nur DB-Status' },
        };
        const dnaBadge = dnaMap[d.dna_match];
        const dnaHtml = dnaBadge
            ? `<span class="inline-flex px-2 py-0.5 rounded text-[10px] font-semibold uppercase border ${dnaBadge.cls}">${dnaBadge.label}</span>`
            : '<span class="text-[10px] text-gray-500">Kein Match</span>';

        const matchedBadges = (d.dna_matched_fields || []).map(f =>
            `<span class="px-1.5 py-0.5 rounded bg-emerald-500/10 text-emerald-400 text-[9px] font-mono border border-emerald-500/20">${f}</span>`
        ).join(' ');

        const syncNote = d.dna_synced
            ? `<div class="px-2 py-1 rounded bg-cyan-500/10 border border-cyan-500/20 text-[10px] text-cyan-400 text-center">
                   ⚡ Auto-Sync: Identity per DNA-Fingerprint erkannt & aktiviert
               </div>`
            : '';

        // Bridge DNA
        const bv = d.bridge_values || {};
        let bridgeHtml = '';
        if (d.bridge_loaded) {
            bridgeHtml = `
                <div class="pt-3 mt-3 border-t border-gray-800/50">
                    <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-2 font-semibold">Bridge DNA (gespoofter Fingerprint)</p>
                    ${popupRow('Serial', bv.serial, true)}
                    ${popupRow('IMEI', bv.imei1, true)}
                    ${popupRow('Android ID', bv.android_id, true)}
                    ${popupRow('GSF ID', bv.gsf_id, true)}
                    ${popupRow('MAC', bv.wifi_mac, true)}
                    ${popupRow('Carrier', bv.operator_name)}
                </div>`;
        }

        body.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider
                             bg-accent-500/10 text-accent-400 border border-accent-500/30">${d.status}</span>
                <span class="text-[10px] text-gray-500">ID #${d.id}</span>
            </div>

            ${syncNote}

            <div class="pt-3 mt-1 border-t border-gray-800/50">
                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-2 font-semibold">DNA Fingerprint</p>
                ${popupRow('Match', dnaHtml)}
                ${matchedBadges ? popupRow('Felder', matchedBadges) : ''}
            </div>

            <div class="pt-3 mt-1 border-t border-gray-800/50">
                <p class="text-[9px] text-gray-600 uppercase tracking-wider mb-1">Säule 1 — Serial / Build</p>
                ${popupRow('Serial', d.serial, true)}
                ${popupRow('Boot Serial', d.boot_serial, true)}
                ${popupRow('Build ID', d.build_id, true)}
                ${popupRow('Fingerprint', d.build_fingerprint, true)}
                ${popupRow('Security Patch', d.security_patch)}
            </div>

            <div class="pt-3 mt-1 border-t border-gray-800/50">
                <p class="text-[9px] text-gray-600 uppercase tracking-wider mb-1">Säule 2 — IMEI / SIM / Telephony</p>
                ${popupRow('IMEI 1', d.imei1, true, true)}
                ${popupRow('IMEI 2', d.imei2, true, true)}
                ${popupRow('IMSI', d.imsi, true, true)}
                ${popupRow('SIM Serial', d.sim_serial, true, true)}
                ${popupRow('Phone', d.phone_number)}
                ${popupRow('Carrier', d.operator_name)}
                ${popupRow('SIM Operator', d.sim_operator ? d.sim_operator + (d.sim_operator_name ? ' (' + d.sim_operator_name + ')' : '') : '—')}
                ${popupRow('Voicemail', d.voicemail_number)}
            </div>

            <div class="pt-3 mt-1 border-t border-gray-800/50">
                <p class="text-[9px] text-gray-600 uppercase tracking-wider mb-1">Säule 3 — Network</p>
                ${popupRow('WiFi MAC', d.wifi_mac, true)}
            </div>

            <div class="pt-3 mt-1 border-t border-gray-800/50">
                <p class="text-[9px] text-gray-600 uppercase tracking-wider mb-1">Säule 4 — DRM</p>
                ${popupRow('Widevine ID', d.widevine_id, true)}
            </div>

            <div class="pt-3 mt-1 border-t border-gray-800/50">
                <p class="text-[9px] text-gray-600 uppercase tracking-wider mb-1">Säule 5 — ID Correlation</p>
                ${popupRow('GSF ID', d.gsf_id, true, true)}
                ${popupRow('Android ID (hex)', d.android_id, true)}
            </div>

            <div class="pt-3 mt-1 border-t border-gray-800/50">
                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-2 font-semibold">Tracking</p>
                ${popupRow('Letzte IP', d.last_public_ip || '—')}
                ${popupRow('Audit Score', d.last_audit_score != null ? d.last_audit_score + '%' : '—')}
                ${popupRow('Verwendet', (d.usage_count || 0) + 'x')}
            </div>

            ${bridgeHtml}
        `;

        modal.classList.remove('hidden');
    }

    function closeActiveIdPopup() {
        document.getElementById('active-id-popup').classList.add('hidden');
    }

    // ===================================================================
    // Log Panel Toggle (fixed bottom-left)
    // ===================================================================
    let _logPanelOpen = true;  // Default: aufgeklappt

    function toggleLogPanel() {
        _logPanelOpen = !_logPanelOpen;
        const terminal = document.getElementById('log-terminal');
        const chevron = document.getElementById('log-panel-chevron');
        if (_logPanelOpen) {
            terminal.classList.remove('hidden');
            chevron.style.transform = '';
        } else {
            terminal.classList.add('hidden');
            chevron.style.transform = 'rotate(180deg)';
        }
    }

    /**
     * Konvertiert einen rein numerischen String in Hex (für IMEI, GSF ID, IMSI, etc.)
     * Gibt null zurück wenn der Wert nicht konvertierbar ist.
     */
    function decToHex(val) {
        if (!val || typeof val !== 'string') return null;
        const clean = val.trim();
        if (!/^\d{8,}$/.test(clean)) return null; // mindestens 8 Ziffern
        try { return BigInt(clean).toString(16).toUpperCase(); }
        catch { return null; }
    }

    function popupRow(label, value, mono, showHex) {
        const val = value || '—';
        const cls = mono ? 'font-mono text-accent-400' : 'text-gray-300';
        const isHtml = typeof val === 'string' && val.startsWith('<');
        const display = isHtml ? val : escapeHtml(String(val));

        let hexLine = '';
        if (showHex && val && val !== '—') {
            const hex = decToHex(val);
            if (hex) {
                hexLine = `<div class="text-right"><span class="text-[9px] font-mono text-gray-600">0x${hex}</span></div>`;
            }
        }

        return `<div class="py-1">
            <div class="flex items-center justify-between">
                <span class="text-xs text-gray-500">${label}</span>
                <span class="text-xs font-medium ${cls}">${display}</span>
            </div>
            ${hexLine}
        </div>`;
    }

    // ===================================================================
    // Helpers
    // ===================================================================
    function infoRow(label, value) {
        return `<div class="flex items-center justify-between py-1">
            <span class="text-xs text-gray-500">${label}</span>
            <span class="text-xs font-medium text-gray-300">${value}</span>
        </div>`;
    }

    function idField(label, value) {
        return `<div class="flex items-center justify-between py-1 border-t border-gray-800/50">
            <span class="text-xs text-gray-500">${label}</span>
            <span class="text-xs font-mono text-gray-300">${escapeHtml(value || '—')}</span>
        </div>`;
    }

    function statusBadge(status) {
        const colors = {
            active:    'bg-green-500/10 text-green-400 border-green-500/30',
            ready:     'bg-blue-500/10 text-blue-400 border-blue-500/30',
            retired:   'bg-gray-500/10 text-gray-400 border-gray-500/30',
            corrupted: 'bg-red-500/10 text-red-400 border-red-500/30',
        };
        const c = colors[status] || colors.ready;
        return `<span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider border ${c}">${status}</span>`;
    }

    function formatDate(iso) {
        if (!iso) return '—';
        try {
            const d = new Date(iso);
            return d.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: '2-digit'}) + ' ' +
                   d.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        } catch { return iso; }
    }

    function showResult(msg, type) {
        const el = document.getElementById('flow-result');
        el.classList.remove('hidden');
        const colors = {
            success: 'bg-green-500/10 border border-green-500/30 text-green-400',
            error:   'bg-red-500/10 border border-red-500/30 text-red-400',
            warn:    'bg-amber-500/10 border border-amber-500/30 text-amber-400',
        };
        el.className = `mt-4 p-3 rounded-lg text-sm ${colors[type] || colors.warn}`;
        el.textContent = msg;
        setTimeout(() => el.classList.add('hidden'), 8000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ===================================================================
    // Identity Detail Modal
    // ===================================================================
    async function openIdentityDetail(identityId) {
        const modal = document.getElementById('identity-detail-modal');
        const body = document.getElementById('detail-body');
        modal.classList.remove('hidden');
        body.innerHTML = '<div class="text-center py-8 text-gray-600 text-sm">Lade Details...</div>';

        try {
            // Lade Identity-Daten
            const [idRes, ipRes, flowRes, auditRes] = await Promise.all([
                fetch('/api/dashboard/identities'),
                fetch(`/api/dashboard/ip-history?identity_id=${identityId}&limit=10`),
                fetch(`/api/dashboard/flow-history?limit=10`),
                fetch(`/api/dashboard/audit-history?identity_id=${identityId}&limit=5`),
            ]);

            const idData = await idRes.json();
            const identity = (idData.identities || []).find(i => i.id === identityId);
            if (!identity) { body.innerHTML = '<div class="text-center py-8 text-red-400">Identity nicht gefunden</div>'; return; }

            const ipData = await ipRes.json();
            const flowData = await flowRes.json();
            const auditData = await auditRes.json();

            // Flows nur für diese Identity filtern
            const flows = (flowData.flows || []).filter(f => f.identity_id === identityId);
            const ips = ipData.ips || [];
            const audits = auditData.audits || [];

            document.getElementById('detail-title').textContent = identity.name;
            document.getElementById('detail-subtitle').textContent = `Identity #${identity.id} — ${identity.status.toUpperCase()} — Erstellt: ${formatDate(identity.created_at)}`;

            // Profil-Daten laden (falls vorhanden)
            let profiles = [];
            try {
                const pRes = await fetch('/api/vault');
                const pData = await pRes.json();
                profiles = (pData.profiles || []).filter(p => p.identity_id === identityId);
            } catch(e) {}

            body.innerHTML = `
                <!-- Spoofed Hardware Identity (vollständig nach Säulen) -->
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-cyan-400 uppercase tracking-wider mb-3">
                        Spoofed Hardware Identity
                        <span class="text-gray-600 font-normal normal-case ml-1">(Bridge-Datei)</span>
                    </h4>

                    <!-- Säule 1: Property / Build -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-2 mb-1">Säule 1 — Serial / Build</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${detailRow('Serial', identity.serial)}
                        ${detailRow('Boot Serial', identity.boot_serial)}
                        ${detailRow('Build ID', identity.build_id)}
                        ${detailRow('Fingerprint', identity.build_fingerprint)}
                        ${detailRow('Security Patch', identity.security_patch)}
                    </div>

                    <!-- Säule 2: IMEI / SIM / Telephony -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-3 mb-1">Säule 2 — IMEI / SIM / Telephony</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${detailRow('IMEI 1', identity.imei1, true)}
                        ${detailRow('IMEI 2', identity.imei2, true)}
                        ${detailRow('IMSI', identity.imsi, true)}
                        ${detailRow('SIM Serial (ICCID)', identity.sim_serial, true)}
                        ${detailRow('Phone', identity.phone_number)}
                        ${detailRow('Carrier', identity.operator_name)}
                        ${detailRow('SIM Operator', identity.sim_operator)}
                        ${detailRow('SIM Op. Name', identity.sim_operator_name)}
                        ${detailRow('Voicemail', identity.voicemail_number)}
                    </div>

                    <!-- Säule 3: Network -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-3 mb-1">Säule 3 — Network Fingerprinting</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${detailRow('WiFi MAC', identity.wifi_mac)}
                    </div>

                    <!-- Säule 4: DRM -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-3 mb-1">Säule 4 — DRM Fingerprinting</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${detailRow('Widevine ID', identity.widevine_id)}
                    </div>

                    <!-- Säule 5: ID Correlation -->
                    <p class="text-[9px] text-gray-600 uppercase tracking-wider mt-3 mb-1">Säule 5 — ID Correlation</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-0.5">
                        ${detailRow('GSF ID', identity.gsf_id, true)}
                        ${detailRow('Android ID (hex)', identity.android_id)}
                    </div>
                </div>

                <!-- Netzwerk & Audit -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-xs font-semibold text-green-400 uppercase tracking-wider mb-3">Netzwerk</h4>
                        ${detailRow('Letzte IP', identity.last_public_ip || '—')}
                        ${detailRow('Service', identity.last_ip_service || '—')}
                        ${detailRow('Zeitpunkt', identity.last_ip_at ? formatDate(identity.last_ip_at) : '—')}
                    </div>
                    <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-xs font-semibold text-amber-400 uppercase tracking-wider mb-3">Audit</h4>
                        ${detailRow('Score', identity.last_audit_score != null ? identity.last_audit_score + '%' : '—')}
                        ${detailRow('Letzter', identity.last_audit_at ? formatDate(identity.last_audit_at) : '—')}
                        ${detailRow('Total', identity.total_audits + ' Audits')}
                        ${detailRow('Verwendet', (identity.usage_count || 0) + 'x')}
                    </div>
                </div>

                <!-- Verknüpfte Profile -->
                ${profiles.length > 0 ? `
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-purple-400 uppercase tracking-wider mb-3">Verknüpfte Profile (${profiles.length})</h4>
                    <div class="space-y-2">
                        ${profiles.map(p => `
                            <div class="flex items-center justify-between py-1.5 border-b border-gray-800/50 last:border-0">
                                <div>
                                    <span class="text-sm font-medium text-gray-200">${escapeHtml(p.name)}</span>
                                    <span class="ml-2 text-[10px] text-gray-500">#${p.id}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${p.tiktok_username ? '<span class="px-1.5 py-0.5 rounded text-[9px] bg-pink-500/10 text-pink-400 border border-pink-500/30">TT</span>' : ''}
                                    ${p.google_email ? '<span class="px-1.5 py-0.5 rounded text-[9px] bg-blue-500/10 text-blue-400 border border-blue-500/30">G</span>' : ''}
                                    ${profileStatusBadge(p.status)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}

                <!-- Backup Info -->
                ${profiles.length > 0 ? `
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-violet-400 uppercase tracking-wider mb-3">Backups</h4>
                    ${profiles.map(p => {
                        const bkps = [];
                        if (p.backup_status === 'valid') bkps.push({type: 'TikTok', path: p.backup_path, size: p.backup_size_bytes, at: p.backup_created_at});
                        if (p.gms_backup_status === 'valid') bkps.push({type: 'GMS', path: p.gms_backup_path, size: p.gms_backup_size, at: p.gms_backup_at});
                        if (p.accounts_backup_status === 'valid') bkps.push({type: 'Accounts', path: p.accounts_backup_path, size: null, at: p.accounts_backup_at});
                        if (bkps.length === 0) return `<div class="text-xs text-gray-600">${escapeHtml(p.name)}: Keine Backups</div>`;
                        return bkps.map(b => `
                            <div class="flex items-center justify-between py-1 border-b border-gray-800/50 last:border-0">
                                <div>
                                    <span class="text-xs text-gray-300">${escapeHtml(p.name)}</span>
                                    <span class="ml-1 px-1.5 py-0.5 rounded text-[9px] bg-green-500/10 text-green-400 border border-green-500/30">${b.type}</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-mono text-[10px] text-gray-500">${b.path || '—'}</div>
                                    <div class="text-[10px] text-gray-600">${b.size ? fmtBytes(b.size) : ''} ${b.at ? formatDate(b.at) : ''}</div>
                                </div>
                            </div>
                        `).join('');
                    }).join('')}
                </div>` : ''}

                <!-- IP History -->
                ${ips.length > 0 ? `
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-cyan-400 uppercase tracking-wider mb-3">IP History (${ips.length})</h4>
                    <div class="space-y-0.5">
                        ${ips.map(ip => `
                            <div class="flex items-center justify-between py-1 border-b border-gray-800/30 last:border-0">
                                <span class="font-mono text-xs text-cyan-300">${ip.public_ip}</span>
                                <div class="text-right">
                                    <span class="text-[10px] text-gray-500">${ip.ip_service || ''}</span>
                                    <span class="text-[10px] text-gray-600 ml-2">${formatDate(ip.detected_at)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}

                <!-- Flow History -->
                ${flows.length > 0 ? `
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-amber-400 uppercase tracking-wider mb-3">Flow History (${flows.length})</h4>
                    <div class="space-y-0.5">
                        ${flows.map(f => `
                            <div class="flex items-center justify-between py-1.5 border-b border-gray-800/30 last:border-0">
                                <div class="flex items-center gap-2">
                                    ${flowTypeBadge(f.flow_type)}
                                    ${flowStatusBadge(f.status)}
                                </div>
                                <div class="text-right">
                                    ${f.public_ip ? `<span class="font-mono text-[10px] text-gray-500">${f.public_ip}</span>` : ''}
                                    ${f.audit_score != null ? `<span class="text-[10px] ml-1 ${f.audit_score >= 100 ? 'text-green-400' : 'text-red-400'}">${f.audit_score}%</span>` : ''}
                                    <span class="text-[10px] text-gray-600 ml-2">${formatDate(f.started_at)}</span>
                                    ${f.duration_ms ? `<span class="text-[10px] text-gray-600 ml-1">(${(f.duration_ms/1000).toFixed(1)}s)</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}

                <!-- Audit History -->
                ${audits.length > 0 ? `
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-800">
                    <h4 class="text-xs font-semibold text-emerald-400 uppercase tracking-wider mb-3">Audit History (${audits.length})</h4>
                    <div class="space-y-0.5">
                        ${audits.map(a => `
                            <div class="flex items-center justify-between py-1 border-b border-gray-800/30 last:border-0">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-xs ${a.score_percent >= 100 ? 'text-green-400' : a.score_percent >= 50 ? 'text-amber-400' : 'text-red-400'}">${a.score_percent}%</span>
                                    <span class="text-[10px] text-gray-500">${a.passed_checks}/${a.total_checks} Checks</span>
                                </div>
                                <span class="text-[10px] text-gray-600">${formatDate(a.created_at)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}
            `;
        } catch (e) {
            body.innerHTML = `<div class="text-center py-8 text-red-400">Fehler: ${escapeHtml(e.message)}</div>`;
        }
    }

    function closeDetailModal() {
        document.getElementById('identity-detail-modal').classList.add('hidden');
    }

    function detailRow(label, value, showHex) {
        const v = String(value || '—');
        const hexLine = (showHex && v !== '—' && /^\d{5,}$/.test(v))
            ? `<span class="block text-[9px] text-gray-600 font-mono">0x${BigInt(v).toString(16).toUpperCase()}</span>`
            : '';
        return `<div class="flex items-center justify-between py-0.5">
            <span class="text-[11px] text-gray-500">${label}</span>
            <span class="text-[11px] font-mono text-gray-300">${escapeHtml(v)}${hexLine}</span>
        </div>`;
    }

    function profileStatusBadge(status) {
        const c = {
            warmup:    'bg-amber-500/10 text-amber-400 border-amber-500/30',
            active:    'bg-green-500/10 text-green-400 border-green-500/30',
            cooldown:  'bg-blue-500/10 text-blue-400 border-blue-500/30',
            banned:    'bg-red-500/10 text-red-400 border-red-500/30',
            suspended: 'bg-orange-500/10 text-orange-400 border-orange-500/30',
            archived:  'bg-gray-500/10 text-gray-400 border-gray-500/30',
        }[status] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';
        return `<span class="px-1.5 py-0.5 rounded text-[9px] font-semibold uppercase border ${c}">${status}</span>`;
    }

    function flowTypeBadge(type) {
        const c = {
            genesis: 'bg-accent-500/10 text-accent-400 border-accent-500/30',
            switch:  'bg-blue-500/10 text-blue-400 border-blue-500/30',
            backup:  'bg-purple-500/10 text-purple-400 border-purple-500/30',
        }[type] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';
        return `<span class="px-1.5 py-0.5 rounded text-[9px] font-semibold uppercase border ${c}">${type}</span>`;
    }

    function flowStatusBadge(status) {
        const c = {
            success: 'bg-green-500/10 text-green-400 border-green-500/30',
            failed:  'bg-red-500/10 text-red-400 border-red-500/30',
            running: 'bg-amber-500/10 text-amber-400 border-amber-500/30',
            aborted: 'bg-gray-500/10 text-gray-400 border-gray-500/30',
        }[status] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';
        return `<span class="px-1.5 py-0.5 rounded text-[9px] font-semibold uppercase border ${c}">${status}</span>`;
    }

    function fmtBytes(bytes) {
        if (!bytes) return '';
        if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(1) + ' GB';
        if (bytes >= 1048576) return (bytes / 1048576).toFixed(1) + ' MB';
        if (bytes >= 1024) return (bytes / 1024).toFixed(0) + ' KB';
        return bytes + ' B';
    }

    // Footer Clock
    function updateClock() {
        const now = new Date();
        document.getElementById('footer-clock').textContent =
            now.toLocaleTimeString('de-DE') + ' UTC' + (now.getTimezoneOffset() > 0 ? '-' : '+') + Math.abs(now.getTimezoneOffset() / 60);
    }

    // ===================================================================
    // USB Cycle / ADB Reconnect
    // ===================================================================
    async function adbReconnect() {
        const btn = document.getElementById('btn-adb-reconnect');
        const icon = document.getElementById('adb-reconnect-icon');
        const spinner = document.getElementById('adb-reconnect-spinner');
        const label = document.getElementById('adb-reconnect-label');

        btn.disabled = true;
        icon.classList.add('hidden');
        spinner.classList.remove('hidden');
        label.textContent = 'Trenne...';

        // Phase-Updates passend zum Backend-Ablauf (~Zeitpunkte)
        const t1 = setTimeout(() => { label.textContent = 'Kabel raus'; }, 1500);
        const t2 = setTimeout(() => { label.textContent = 'Warte...'; }, 3500);
        const t3 = setTimeout(() => { label.textContent = 'Kabel rein'; }, 5500);
        const t4 = setTimeout(() => { label.textContent = 'Suche...'; }, 8000);

        try {
            const res = await fetch('/api/control/adb/reconnect', { method: 'POST' });
            const data = await res.json();

            if (data.status === 'connected') {
                showResult(data.message, 'success');
                refreshStats();
            } else {
                showResult(data.message, 'error');
            }
        } catch (e) {
            showResult('USB-Cycle Fehler: ' + e.message, 'error');
        } finally {
            clearTimeout(t1);
            clearTimeout(t2);
            clearTimeout(t3);
            clearTimeout(t4);
            btn.disabled = false;
            icon.classList.remove('hidden');
            spinner.classList.add('hidden');
            label.textContent = 'USB';
        }
    }

    // ===================================================================
    // scrcpy: Screen Mirroring
    // ===================================================================
    let scrcpyRunning = false;

    async function toggleScrcpy() {
        const btn = document.getElementById('btn-scrcpy');
        const label = document.getElementById('scrcpy-label');
        btn.disabled = true;

        try {
            if (scrcpyRunning) {
                const res = await fetch('/api/control/scrcpy/stop', { method: 'POST' });
                const data = await res.json();
                scrcpyRunning = false;
                updateScrcpyButton();
                showResult(data.message, 'success');
            } else {
                const res = await fetch('/api/control/scrcpy/start', { method: 'POST' });
                const data = await res.json();
                if (res.ok) {
                    scrcpyRunning = data.status === 'started' || data.status === 'already_running';
                    updateScrcpyButton();
                    showResult(data.message, 'success');
                } else {
                    showResult(data.detail || 'scrcpy Fehler', 'error');
                }
            }
        } catch (e) {
            showResult('scrcpy Fehler: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
        }
    }

    function updateScrcpyButton() {
        const btn = document.getElementById('btn-scrcpy');
        const label = document.getElementById('scrcpy-label');

        if (scrcpyRunning) {
            btn.className = 'px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all border border-emerald-500/40 bg-emerald-500/15 text-emerald-400 hover:bg-emerald-500/25';
            label.textContent = 'Mirror aktiv';
        } else {
            btn.className = 'px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all border border-gray-700 bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700';
            label.textContent = 'Mirror';
        }
    }

    async function checkScrcpyStatus() {
        try {
            const res = await fetch('/api/control/scrcpy/status');
            const data = await res.json();
            scrcpyRunning = data.running;
            updateScrcpyButton();
        } catch (e) { /* ignore */ }
    }

    // ===================================================================
    // Init
    // ===================================================================
    document.addEventListener('DOMContentLoaded', () => {
        connectWS();
        refreshStats();
        loadVault();
        loadFlowHistory();
        updateClock();
        checkScrcpyStatus();

        // Periodisches Refresh (adaptiv: schneller wenn Flow aktiv)
        let statsPollHandle = setInterval(refreshStats, POLL_INTERVAL_MS);
        setInterval(updateClock, 1000);

        // Vault + Flow-History periodisch aktualisieren (15s)
        // Damit Name-Änderungen und Backup-Status synchron bleiben
        setInterval(() => { loadVault(); loadFlowHistory(); }, 15000);

        // Adaptiver Poll: Wenn ein Flow startet/stoppt, Interval anpassen
        window._adjustPollRate = function(flowActive) {
            const newRate = flowActive ? POLL_INTERVAL_ACTIVE_MS : POLL_INTERVAL_IDLE_MS;
            if (newRate !== POLL_INTERVAL_MS) {
                POLL_INTERVAL_MS = newRate;
                clearInterval(statsPollHandle);
                statsPollHandle = setInterval(refreshStats, POLL_INTERVAL_MS);
            }
        };

        // Check ob bereits ein Flow läuft
        fetch('/api/control/status').then(r => r.json()).then(data => {
            if (data.running) {
                startFlowPolling();
                window._adjustPollRate(true);
            }
        });
    });

    // Escape-Taste schliesst Modals
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeActiveIdPopup();
            closeDetailModal();
        }
    });
</script>
</body>
</html>
