<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-950">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Titan — Command Center</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        titan: {
                            50:  '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0',
                            300: '#86efac', 400: '#4ade80', 500: '#22c55e',
                            600: '#16a34a', 700: '#15803d', 800: '#166534',
                            900: '#14532d', 950: '#052e16',
                        }
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Terminal Styling */
        #log-terminal {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        #log-terminal .log-info  { color: #a3e635; }
        #log-terminal .log-warn  { color: #facc15; }
        #log-terminal .log-error { color: #f87171; }
        #log-terminal .log-debug { color: #94a3b8; }
        #log-terminal .log-ts    { color: #64748b; }
        #log-terminal .log-name  { color: #67e8f9; }

        /* Pulse Animation */
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }

        /* HTMX Loading Indicator */
        .htmx-request .btn-label { display: none; }
        .htmx-request .btn-loading { display: inline-flex; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
    </style>
</head>
<body class="h-full text-gray-100 antialiased">

<div class="min-h-full flex flex-col">

    <!-- =============================================================== -->
    <!-- HEADER -->
    <!-- =============================================================== -->
    <header class="bg-gray-900/80 backdrop-blur-sm border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14">
                <!-- Logo / Title -->
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-titan-400 to-emerald-600 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-sm font-semibold text-white tracking-wide">PROJECT TITAN</h1>
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest">Command Center v1.0</p>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex items-center gap-1">
                    <a href="/"
                       class="px-3 py-1.5 rounded-lg text-xs font-medium text-white bg-gray-800 border border-gray-700">
                        Dashboard
                    </a>
                    <a href="/vault"
                       class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-all">
                        Vault
                    </a>
                </nav>

                <!-- Status Indicator -->
                <div id="header-status" class="flex items-center gap-3">
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-800/60 border border-gray-700">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-600"></div>
                        <span id="status-text" class="text-xs font-medium text-gray-400">Verbinde...</span>
                    </div>
                    <div id="flow-badge" class="hidden items-center gap-2 px-3 py-1.5 rounded-full bg-amber-500/10 border border-amber-500/30">
                        <svg class="w-3 h-3 text-amber-400 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <span id="flow-badge-text" class="text-xs font-medium text-amber-400">Flow aktiv</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- =============================================================== -->
    <!-- MAIN CONTENT -->
    <!-- =============================================================== -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">

            <!-- ======================================================= -->
            <!-- CARD: Current Identity -->
            <!-- ======================================================= -->
            <div class="bg-gray-900/50 border border-gray-800 rounded-xl p-5">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-4 h-4 text-titan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0"/>
                    </svg>
                    <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Active Identity</h2>
                </div>

                <div id="identity-card" class="space-y-3">
                    <div class="text-center py-6 text-gray-600">
                        <p class="text-sm">Keine aktive Identität</p>
                    </div>
                </div>
            </div>

            <!-- ======================================================= -->
            <!-- CARD: Action Panel -->
            <!-- ======================================================= -->
            <div class="bg-gray-900/50 border border-gray-800 rounded-xl p-5">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Actions</h2>
                </div>

                <div class="space-y-3">
                    <!-- Genesis Button -->
                    <div class="space-y-2">
                        <input type="text" id="genesis-name" placeholder="Identity Name (z.B. DE_Berlin_001)"
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-200
                                      placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-titan-500/50 focus:border-titan-500">
                        <button id="btn-genesis"
                                onclick="startGenesis()"
                                class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg
                                       bg-gradient-to-r from-titan-600 to-emerald-600
                                       hover:from-titan-500 hover:to-emerald-500
                                       text-white font-semibold text-sm
                                       transition-all duration-200 shadow-lg shadow-titan-500/20
                                       disabled:opacity-40 disabled:cursor-not-allowed">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            <span class="btn-label">GENESIS</span>
                            <span class="btn-loading hidden items-center gap-2">
                                <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                </svg>
                                Läuft...
                            </span>
                        </button>
                    </div>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-800"></div></div>
                        <div class="relative flex justify-center"><span class="bg-gray-900/50 px-2 text-xs text-gray-600">oder</span></div>
                    </div>

                    <!-- Switch Button -->
                    <div class="space-y-2">
                        <input type="number" id="switch-id" placeholder="Identity ID zum Laden"
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-200
                                      placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500">
                        <button id="btn-switch"
                                onclick="startSwitch()"
                                class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg
                                       bg-gradient-to-r from-blue-600 to-indigo-600
                                       hover:from-blue-500 hover:to-indigo-500
                                       text-white font-semibold text-sm
                                       transition-all duration-200 shadow-lg shadow-blue-500/20
                                       disabled:opacity-40 disabled:cursor-not-allowed">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                            </svg>
                            <span class="btn-label">SWITCH</span>
                            <span class="btn-loading hidden items-center gap-2">
                                <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                </svg>
                                Läuft...
                            </span>
                        </button>
                    </div>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-800"></div></div>
                        <div class="relative flex justify-center"><span class="bg-gray-900/50 px-2 text-xs text-gray-600">Backup</span></div>
                    </div>

                    <!-- Backup Button -->
                    <div class="space-y-2">
                        <input type="text" id="backup-name" placeholder="Profil-Name f. Backup (z.B. DE_Berlin_001)"
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-200
                                      placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500">
                        <button id="btn-backup"
                                onclick="startBackup()"
                                class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg
                                       bg-gradient-to-r from-purple-600 to-violet-600
                                       hover:from-purple-500 hover:to-violet-500
                                       text-white font-semibold text-sm
                                       transition-all duration-200 shadow-lg shadow-purple-500/20
                                       disabled:opacity-40 disabled:cursor-not-allowed">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <span class="btn-label">FULL-STATE BACKUP</span>
                            <span class="btn-loading hidden items-center gap-2">
                                <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                </svg>
                                Sichert...
                            </span>
                        </button>
                        <p class="text-[10px] text-gray-600 text-center">GMS + TikTok + Account-DBs sichern</p>
                    </div>

                    <!-- Abort Button -->
                    <button id="btn-abort"
                            onclick="abortFlow()"
                            class="hidden w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg
                                   bg-red-600/20 border border-red-600/40 hover:bg-red-600/30
                                   text-red-400 font-medium text-xs transition-all">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        ABORT
                    </button>
                </div>

                <!-- Flow Result Toast -->
                <div id="flow-result" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
            </div>

            <!-- ======================================================= -->
            <!-- CARD: Device Status -->
            <!-- ======================================================= -->
            <div class="bg-gray-900/50 border border-gray-800 rounded-xl p-5">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Device</h2>
                </div>

                <div id="device-info" class="space-y-2.5">
                    <div class="text-center py-6 text-gray-600">
                        <p class="text-sm">Lade Device-Info...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- =============================================================== -->
        <!-- LIVE LOGS -->
        <!-- =============================================================== -->
        <div class="mt-5 bg-gray-900/50 border border-gray-800 rounded-xl overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3 border-b border-gray-800">
                <div class="flex items-center gap-2">
                    <div class="flex gap-1.5">
                        <div class="w-3 h-3 rounded-full bg-red-500/80"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500/80"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500/80"></div>
                    </div>
                    <span class="text-xs font-medium text-gray-500 ml-2">Live Logs</span>
                    <div id="ws-indicator" class="w-1.5 h-1.5 rounded-full bg-gray-600 ml-1"></div>
                </div>
                <button onclick="clearLogs()" class="text-xs text-gray-600 hover:text-gray-400 transition-colors">Clear</button>
            </div>
            <div id="log-terminal" class="h-72 overflow-y-auto bg-gray-950 px-4 py-3 space-y-0.5">
                <div class="text-gray-600 text-xs">Warte auf Verbindung...</div>
            </div>
        </div>

        <!-- =============================================================== -->
        <!-- FLOW HISTORY TABLE -->
        <!-- =============================================================== -->
        <div class="mt-5 bg-gray-900/50 border border-gray-800 rounded-xl overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3 border-b border-gray-800">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Flow History</h2>
                    <span id="flow-history-count" class="text-xs text-gray-600 ml-1">(0)</span>
                </div>
                <button onclick="loadFlowHistory()" class="text-xs text-amber-400 hover:text-amber-300 transition-colors">Refresh</button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left text-xs text-gray-500 uppercase tracking-wider bg-gray-900/30">
                            <th class="px-5 py-2.5 font-medium w-12">ID</th>
                            <th class="px-5 py-2.5 font-medium">Type</th>
                            <th class="px-5 py-2.5 font-medium">Status</th>
                            <th class="px-5 py-2.5 font-medium">Identity</th>
                            <th class="px-5 py-2.5 font-medium">IP</th>
                            <th class="px-5 py-2.5 font-medium">Audit</th>
                            <th class="px-5 py-2.5 font-medium">Duration</th>
                            <th class="px-5 py-2.5 font-medium">Time</th>
                        </tr>
                    </thead>
                    <tbody id="flow-history-body" class="divide-y divide-gray-800/50">
                        <tr><td colspan="8" class="px-5 py-6 text-center text-gray-600 text-sm">Lade Flow-History...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- =============================================================== -->
        <!-- VAULT TABLE: Identities -->
        <!-- =============================================================== -->
        <div class="mt-5 bg-gray-900/50 border border-gray-800 rounded-xl overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3 border-b border-gray-800">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                    </svg>
                    <h2 class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Identity Vault</h2>
                    <span id="vault-count" class="text-xs text-gray-600 ml-1">(0)</span>
                </div>
                <button onclick="loadVault()" class="text-xs text-titan-400 hover:text-titan-300 transition-colors">Refresh</button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left text-xs text-gray-500 uppercase tracking-wider bg-gray-900/30">
                            <th class="px-5 py-2.5 font-medium">ID</th>
                            <th class="px-5 py-2.5 font-medium">Name</th>
                            <th class="px-5 py-2.5 font-medium">Serial</th>
                            <th class="px-5 py-2.5 font-medium">IMEI</th>
                            <th class="px-5 py-2.5 font-medium">Phone</th>
                            <th class="px-5 py-2.5 font-medium">Status</th>
                            <th class="px-5 py-2.5 font-medium">IP</th>
                            <th class="px-5 py-2.5 font-medium">Audit</th>
                            <th class="px-5 py-2.5 font-medium">Uses</th>
                            <th class="px-5 py-2.5 font-medium text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="vault-body" class="divide-y divide-gray-800/50">
                        <tr>
                            <td colspan="8" class="px-5 py-8 text-center text-gray-600 text-sm">
                                Keine Identitäten im Vault
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- =============================================================== -->
    <!-- FOOTER -->
    <!-- =============================================================== -->
    <footer class="border-t border-gray-800/50 py-3">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between">
            <p class="text-[10px] text-gray-700">Project Titan v1.0.0 &mdash; O2-DE / Pixel 6 / KernelSU</p>
            <p class="text-[10px] text-gray-700" id="footer-clock"></p>
        </div>
    </footer>
</div>

<!-- =============================================================== -->
<!-- JAVASCRIPT -->
<!-- =============================================================== -->
<script>
    // ===================================================================
    // Config
    // ===================================================================
    const WS_URL = `ws://${location.host}/ws/logs`;
    const POLL_INTERVAL_MS = 3000;
    const STATUS_POLL_MS = 2000;

    let ws = null;
    let statusPoll = null;
    let flowRunning = false;

    // ===================================================================
    // WebSocket: Live Logs
    // ===================================================================
    function connectWS() {
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
            document.getElementById('ws-indicator').classList.replace('bg-gray-600', 'bg-green-500');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'pong') return;
            appendLog(data);
        };

        ws.onclose = () => {
            document.getElementById('ws-indicator').classList.replace('bg-green-500', 'bg-gray-600');
            // Reconnect nach 3s
            setTimeout(connectWS, 3000);
        };

        ws.onerror = () => { ws.close(); };
    }

    function appendLog(entry) {
        const terminal = document.getElementById('log-terminal');
        const line = document.createElement('div');
        const levelClass = {
            'INFO': 'log-info', 'WARNING': 'log-warn',
            'ERROR': 'log-error', 'DEBUG': 'log-debug',
        }[entry.level] || 'log-info';

        line.innerHTML = `<span class="log-ts">${entry.ts}</span> <span class="log-name">[${entry.name}]</span> <span class="${levelClass}">${escapeHtml(entry.msg)}</span>`;
        terminal.appendChild(line);

        // Auto-scroll
        terminal.scrollTop = terminal.scrollHeight;

        // Max 500 Zeilen
        while (terminal.children.length > 500) {
            terminal.removeChild(terminal.firstChild);
        }
    }

    function clearLogs() {
        document.getElementById('log-terminal').innerHTML = '';
    }

    // ===================================================================
    // Dashboard: Stats Polling
    // ===================================================================
    async function refreshStats() {
        try {
            const res = await fetch('/api/dashboard/stats');
            const data = await res.json();

            // Status Dot
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if (data.adb_connected) {
                dot.className = 'w-2 h-2 rounded-full bg-green-500 pulse-dot';
                txt.textContent = 'Online';
                txt.className = 'text-xs font-medium text-green-400';
            } else {
                dot.className = 'w-2 h-2 rounded-full bg-red-500';
                txt.textContent = 'Offline';
                txt.className = 'text-xs font-medium text-red-400';
            }

            // Device Info Card
            const deviceEl = document.getElementById('device-info');
            deviceEl.innerHTML = `
                ${infoRow('ADB', data.adb_connected ? '<span class="text-green-400">Verbunden</span>' : '<span class="text-red-400">Getrennt</span>')}
                ${infoRow('Root', data.root_access ? '<span class="text-green-400">Aktiv (KSU)</span>' : '<span class="text-gray-500">Nicht verfügbar</span>')}
                ${infoRow('Serial', data.device_serial || '<span class="text-gray-600">—</span>')}
                ${infoRow('Device IP', data.device_ip || '<span class="text-gray-600">—</span>')}
                <div class="pt-2 mt-2 border-t border-gray-800/50">
                    <p class="text-[10px] text-gray-600 uppercase tracking-wider mb-1">Farm Stats</p>
                    ${infoRow('Identities', data.counts.identities)}
                    ${infoRow('Profiles', data.counts.profiles)}
                    ${infoRow('Flows', data.counts.flows_total + ' (' + data.counts.flows_success + ' OK)')}
                    ${infoRow('Unique IPs', data.counts.unique_ips)}
                </div>
            `;

            // Active Identity Card (Erweitert mit IP/Audit)
            const idEl = document.getElementById('identity-card');
            if (data.active_identity) {
                const id = data.active_identity;
                idEl.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-lg font-bold text-titan-400">${escapeHtml(id.name)}</span>
                        <span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider
                                     bg-titan-500/10 text-titan-400 border border-titan-500/30">${id.status}</span>
                    </div>
                    ${idField('Serial', id.serial)}
                    ${idField('IMEI', id.imei1)}
                    ${idField('Phone', id.phone_number)}
                    ${idField('Carrier', id.operator_name + ' (' + id.sim_operator + ')')}
                    ${idField('MAC', id.wifi_mac)}
                    <div class="mt-2 pt-2 border-t border-gray-800/50">
                        ${idField('Letzte IP', id.last_public_ip || '—')}
                        ${idField('Audit', id.last_audit_score != null ? id.last_audit_score + '%' : '—')}
                        ${idField('Verwendet', (id.usage_count || 0) + 'x')}
                    </div>
                `;
            } else {
                idEl.innerHTML = '<div class="text-center py-6 text-gray-600"><p class="text-sm">Keine aktive Identität</p><p class="text-xs mt-1">Starte einen Genesis-Flow</p></div>';
            }
        } catch (e) {
            console.error('Stats refresh error:', e);
        }
    }

    // ===================================================================
    // Flow Control
    // ===================================================================
    async function startGenesis() {
        const name = document.getElementById('genesis-name').value.trim();
        if (!name) {
            showResult('Bitte einen Namen eingeben.', 'warn');
            return;
        }

        const btn = document.getElementById('btn-genesis');
        btn.disabled = true;

        try {
            const res = await fetch('/api/control/genesis', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name}),
            });
            const data = await res.json();

            if (res.ok) {
                showResult(data.message, 'success');
                startFlowPolling();
            } else {
                showResult(data.detail || 'Fehler', 'error');
                btn.disabled = false;
            }
        } catch (e) {
            showResult('Netzwerkfehler: ' + e.message, 'error');
            btn.disabled = false;
        }
    }

    async function startSwitch() {
        const id = document.getElementById('switch-id').value;
        if (!id) {
            showResult('Bitte eine Identity ID eingeben.', 'warn');
            return;
        }

        const btn = document.getElementById('btn-switch');
        btn.disabled = true;

        // Versuche den Identity-Namen als Profil-Name zu verwenden (Full-State)
        // Falls kein Profil-Backup existiert, fällt der Flow automatisch auf Legacy zurück
        let profileName = null;
        try {
            const idRes = await fetch('/api/dashboard/identities');
            const idData = await idRes.json();
            const identity = (idData.identities || []).find(i => i.id === parseInt(id));
            if (identity) profileName = identity.name;
        } catch(e) { /* ignore */ }

        try {
            const body = profileName
                ? { profile_name: profileName }
                : {};

            const res = await fetch(`/api/control/switch/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body),
            });
            const data = await res.json();

            if (res.ok) {
                showResult(data.message, 'success');
                startFlowPolling();
            } else {
                showResult(data.detail || 'Fehler', 'error');
                btn.disabled = false;
            }
        } catch (e) {
            showResult('Netzwerkfehler: ' + e.message, 'error');
            btn.disabled = false;
        }
    }

    async function startBackup() {
        const name = document.getElementById('backup-name').value.trim();
        if (!name) {
            showResult('Bitte einen Profil-Namen eingeben.', 'warn');
            return;
        }

        const btn = document.getElementById('btn-backup');
        btn.disabled = true;

        try {
            const res = await fetch('/api/control/backup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ profile_name: name }),
            });
            const data = await res.json();

            if (res.ok) {
                showResult(data.message, 'success');
                startFlowPolling();
            } else {
                showResult(data.detail || 'Fehler', 'error');
                btn.disabled = false;
            }
        } catch (e) {
            showResult('Netzwerkfehler: ' + e.message, 'error');
            btn.disabled = false;
        }
    }

    async function abortFlow() {
        try {
            await fetch('/api/control/abort', {method: 'POST'});
            showResult('Flow abgebrochen.', 'warn');
            stopFlowPolling();
        } catch (e) {
            console.error('Abort error:', e);
        }
    }

    // ===================================================================
    // Flow Status Polling
    // ===================================================================
    function startFlowPolling() {
        flowRunning = true;
        document.getElementById('btn-genesis').disabled = true;
        document.getElementById('btn-switch').disabled = true;
        document.getElementById('btn-backup').disabled = true;
        document.getElementById('btn-abort').classList.remove('hidden');
        document.getElementById('btn-abort').classList.add('flex');
        document.getElementById('flow-badge').classList.remove('hidden');
        document.getElementById('flow-badge').classList.add('flex');

        statusPoll = setInterval(pollFlowStatus, STATUS_POLL_MS);
    }

    function stopFlowPolling() {
        flowRunning = false;
        if (statusPoll) clearInterval(statusPoll);
        statusPoll = null;
        document.getElementById('btn-genesis').disabled = false;
        document.getElementById('btn-switch').disabled = false;
        document.getElementById('btn-backup').disabled = false;
        document.getElementById('btn-abort').classList.add('hidden');
        document.getElementById('btn-abort').classList.remove('flex');
        document.getElementById('flow-badge').classList.add('hidden');
        document.getElementById('flow-badge').classList.remove('flex');
    }

    async function pollFlowStatus() {
        try {
            const res = await fetch('/api/control/status');
            const data = await res.json();

            document.getElementById('flow-badge-text').textContent =
                data.flow_type ? data.flow_type.toUpperCase() + ' aktiv' : 'Flow aktiv';

            if (!data.running && flowRunning) {
                // Flow beendet
                stopFlowPolling();
                refreshStats();
                loadVault();
                loadFlowHistory();

                if (data.result && data.result.success) {
                    showResult('Flow erfolgreich abgeschlossen!', 'success');
                } else {
                    showResult('Flow fehlgeschlagen: ' + (data.error || 'Unbekannter Fehler'), 'error');
                }
            }
        } catch (e) {
            console.error('Status poll error:', e);
        }
    }

    // ===================================================================
    // Vault (Identities List)
    // ===================================================================
    async function loadVault() {
        try {
            const res = await fetch('/api/dashboard/identities');
            const data = await res.json();
            const tbody = document.getElementById('vault-body');
            const count = document.getElementById('vault-count');

            const identities = data.identities || [];
            count.textContent = `(${identities.length})`;

            if (identities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="px-5 py-8 text-center text-gray-600 text-sm">Keine Identitäten im Vault</td></tr>';
                return;
            }

            tbody.innerHTML = identities.map(id => `
                <tr class="hover:bg-gray-800/30 transition-colors group">
                    <td class="px-5 py-2.5 font-mono text-xs text-gray-500">#${id.id}</td>
                    <td class="px-5 py-2.5 font-medium text-gray-200">${escapeHtml(id.name)}</td>
                    <td class="px-5 py-2.5 font-mono text-xs text-gray-400">${id.serial}</td>
                    <td class="px-5 py-2.5 font-mono text-xs text-gray-400">${id.imei1 ? id.imei1.substring(0,6) + '...' + id.imei1.substring(11) : '—'}</td>
                    <td class="px-5 py-2.5 font-mono text-xs text-gray-400">${id.phone_number || '—'}</td>
                    <td class="px-5 py-2.5">
                        ${statusBadge(id.status)}
                    </td>
                    <td class="px-5 py-2.5 font-mono text-xs text-gray-500">${id.last_public_ip || '—'}</td>
                    <td class="px-5 py-2.5 text-xs">
                        ${id.last_audit_score != null
                            ? `<span class="${id.last_audit_score >= 100 ? 'text-green-400' : id.last_audit_score >= 50 ? 'text-amber-400' : 'text-red-400'} font-semibold">${id.last_audit_score}%</span>`
                            : '<span class="text-gray-600">—</span>'
                        }
                    </td>
                    <td class="px-5 py-2.5 text-center font-mono text-xs text-gray-500">${id.usage_count || 0}</td>
                    <td class="px-5 py-2.5 text-right">
                        <button onclick="quickSwitch(${id.id})"
                                class="opacity-0 group-hover:opacity-100 px-2.5 py-1 rounded text-xs font-medium
                                       bg-blue-600/20 text-blue-400 border border-blue-600/30 hover:bg-blue-600/30
                                       transition-all duration-200"
                                ${id.status === 'active' ? 'disabled' : ''}>
                            Load
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            console.error('Vault load error:', e);
        }
    }

    function quickSwitch(id) {
        document.getElementById('switch-id').value = id;
        startSwitch();
    }

    // ===================================================================
    // Flow History
    // ===================================================================
    async function loadFlowHistory() {
        try {
            const res = await fetch('/api/dashboard/flow-history?limit=20');
            const data = await res.json();
            const tbody = document.getElementById('flow-history-body');
            const count = document.getElementById('flow-history-count');

            const flows = data.flows || [];
            count.textContent = `(${flows.length})`;

            if (flows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-5 py-6 text-center text-gray-600 text-sm">Noch keine Flows ausgeführt</td></tr>';
                return;
            }

            tbody.innerHTML = flows.map(f => {
                const typeBadge = {
                    genesis: 'bg-titan-500/10 text-titan-400 border-titan-500/30',
                    switch:  'bg-blue-500/10 text-blue-400 border-blue-500/30',
                    backup:  'bg-purple-500/10 text-purple-400 border-purple-500/30',
                }[f.flow_type] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';

                const statusBg = {
                    success: 'bg-green-500/10 text-green-400 border-green-500/30',
                    failed:  'bg-red-500/10 text-red-400 border-red-500/30',
                    running: 'bg-amber-500/10 text-amber-400 border-amber-500/30',
                    aborted: 'bg-gray-500/10 text-gray-400 border-gray-500/30',
                }[f.status] || 'bg-gray-500/10 text-gray-400 border-gray-500/30';

                const durStr = f.duration_ms ? (f.duration_ms / 1000).toFixed(1) + 's' : '—';

                return `<tr class="hover:bg-gray-800/30 transition-colors">
                    <td class="px-5 py-2 font-mono text-xs text-gray-500">#${f.id}</td>
                    <td class="px-5 py-2"><span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase border ${typeBadge}">${f.flow_type}</span></td>
                    <td class="px-5 py-2"><span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase border ${statusBg}">${f.status}</span></td>
                    <td class="px-5 py-2 font-mono text-xs text-gray-400">${f.generated_serial || (f.identity_id ? '#' + f.identity_id : '—')}</td>
                    <td class="px-5 py-2 font-mono text-xs text-gray-500">${f.public_ip || '—'}</td>
                    <td class="px-5 py-2 text-xs">${f.audit_score != null ? `<span class="${f.audit_score >= 100 ? 'text-green-400' : 'text-red-400'} font-semibold">${f.audit_score}%</span>` : '—'}</td>
                    <td class="px-5 py-2 font-mono text-xs text-gray-500">${durStr}</td>
                    <td class="px-5 py-2 text-xs text-gray-500">${formatDate(f.started_at)}</td>
                </tr>`;
            }).join('');
        } catch (e) {
            console.error('Flow history load error:', e);
        }
    }

    // ===================================================================
    // Helpers
    // ===================================================================
    function infoRow(label, value) {
        return `<div class="flex items-center justify-between py-1">
            <span class="text-xs text-gray-500">${label}</span>
            <span class="text-xs font-medium text-gray-300">${value}</span>
        </div>`;
    }

    function idField(label, value) {
        return `<div class="flex items-center justify-between py-1 border-t border-gray-800/50">
            <span class="text-xs text-gray-500">${label}</span>
            <span class="text-xs font-mono text-gray-300">${escapeHtml(value || '—')}</span>
        </div>`;
    }

    function statusBadge(status) {
        const colors = {
            active:    'bg-green-500/10 text-green-400 border-green-500/30',
            ready:     'bg-blue-500/10 text-blue-400 border-blue-500/30',
            retired:   'bg-gray-500/10 text-gray-400 border-gray-500/30',
            corrupted: 'bg-red-500/10 text-red-400 border-red-500/30',
        };
        const c = colors[status] || colors.ready;
        return `<span class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider border ${c}">${status}</span>`;
    }

    function formatDate(iso) {
        if (!iso) return '—';
        try {
            const d = new Date(iso);
            return d.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: '2-digit'}) + ' ' +
                   d.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        } catch { return iso; }
    }

    function showResult(msg, type) {
        const el = document.getElementById('flow-result');
        el.classList.remove('hidden');
        const colors = {
            success: 'bg-green-500/10 border border-green-500/30 text-green-400',
            error:   'bg-red-500/10 border border-red-500/30 text-red-400',
            warn:    'bg-amber-500/10 border border-amber-500/30 text-amber-400',
        };
        el.className = `mt-4 p-3 rounded-lg text-sm ${colors[type] || colors.warn}`;
        el.textContent = msg;
        setTimeout(() => el.classList.add('hidden'), 8000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Footer Clock
    function updateClock() {
        const now = new Date();
        document.getElementById('footer-clock').textContent =
            now.toLocaleTimeString('de-DE') + ' UTC' + (now.getTimezoneOffset() > 0 ? '-' : '+') + Math.abs(now.getTimezoneOffset() / 60);
    }

    // ===================================================================
    // Init
    // ===================================================================
    document.addEventListener('DOMContentLoaded', () => {
        connectWS();
        refreshStats();
        loadVault();
        loadFlowHistory();
        updateClock();

        // Periodisches Refresh
        setInterval(refreshStats, POLL_INTERVAL_MS);
        setInterval(updateClock, 1000);

        // Check ob bereits ein Flow läuft
        fetch('/api/control/status').then(r => r.json()).then(data => {
            if (data.running) startFlowPolling();
        });
    });
</script>
</body>
</html>
